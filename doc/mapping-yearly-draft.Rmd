---
title: "St. Louis Central Corridor West Building Permits"
subtitle: "Monthly Report: January 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  
  year: 2020
  pastyear: 2019
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

Before running this code make sure that all params are changed to the correct dates!

```{r, include=FALSE}
#load dependencies
library(dplyr)        # data manipulation
library(readr)        #download csv
library(here)         #file path management
library(kableExtra)   #data tables

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(sf)           # spatial data tools

#other packages
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(knitr)
library(ggplot2)      # plot making
library(formattable)  # currency values
library(lubridate)    # manipulate date time data
library(officer)      # powerpoint manipulation
library(flextable)    # nice tables
library(customLayout) # custom powerpoint layout
library(rlang)        # check for empty values
library(tidyr)        # used to drop NA
library(docxtractr)   #convert pptx to pdf
library(gateway)
library(grid)
```

```{r, include=FALSE}
#load data
setwd('/Users/loganbogenut/Documents/GitHub/stl-building-permits')

#load data
df <- read_csv(here::here("data", params$year, "yearly", "clean_year.csv"))
yr5 <- read_csv(here::here("data", params$year, "yearly", "5year.csv"))
lastyr <- read_csv(here::here("data", params$pastyear, "yearly", "clean_year.csv"))
bound <- gw_get_data("Neighborhoods", "sf")
nbhd_num <- c("38", "39", "46", "47", "48", "49", "51", "53", "54", "58")

load(file = here::here("data", "basemap_tiles", "mapbox-tiles.rda"))
load(file = here::here("data", "basemap_tiles", "boundaries.rda"))
load(file = here::here("data", "basemap_tiles", "nbhd-boundaries.rda"))

# create dataframe of means
df %>%
  group_by(nbhd_name, new_use) %>%
  summarise(mean = mean(EstProjectCost), count1 = mean(count), high_cost = sum(big_cost, na.rm = TRUE), low_cost = sum(lil_cost, na.rm = TRUE)) -> means

#create powerpoint
report <- read_pptx()

neighborhoods <- c(38, 39, 46:49, 51, 53, 54, 58)
names <- c("Central West End", "Forest Park Southeast", "Skinker DeBaliviere", "DeBaliviere Place", "West End", "Visitation Park", "Academy", "Fountain Park", "Lewis Place", "Vandeventer")
use <- c("Industrial", "Institutional", "Residential", "Commercial")
```

#Function References

`lay_new` creates a custom layout. You use the `matrix` argument to specify the location of figures.

`lay_bind_row` combines custom layouts. In this instance, we are combining the title layout with the body layout for our powerpoint slide.

`phl_layout` transforms your custom layout to an officer PowerPoint slide.

`fp_text` creates a font style for an officer powerpoint slide.

`ftext` creates a formatted chunk of text, often referencing `fp_text` for formatting instructions.

`fpar` creates formatted paragraphs in Powerpoint. Used to concatenate `ftext` objects into a paragraph.

`block_list` combines several blocks, or `fpar` objects, into a single object. Used to create formatted paragraphs in Powerpoint.

`read_pptx` creates a powerpoint presentation. You can use a variety of functions to add content to the presentation once the object is created.

`add_slide` adds a powerpoint slide to an existing powerpoint object. Specify what kind of layout you want the slide to be.

`ph_with` adds content to an existing powerpoint slide. This function often follows the `add_slide` function. This function is used to add everything from tables, to titles to body paragraphs on your powerpoint slide.

`sprintf` creates a character vector containing a formatted combination of text and variable values. In this notebook it is used for summary notes where it references the paramaters as well as certain variable values.

`filter` is a dplyr function that is used to clean data. Specifically it is used to find rows/cases where a condition is true. If the condition is true then the values are kept, if not they are dropped.

`group_by` takes an existing tbl and converts it into a grouped tbl based on a specific variable.

`rename` does exactly what you think it does. It renames variables based on name.

`replace` replaces a certain value with another. It is used in this notebook to replace NAs with 0.

`add_row` adds a row to a dataframe. It is used to add rows to tables based on whether or not a specific crime was committed. So, if there were no arsons that month, the `add_row` function is used to add this crime with values of 0.

`arrange` sorts a variable in ascending order

`adorn_totals` adds a "totals" row or column to a data frame.

`colformat_num` formats numeric variables in a flextable. Specifically aimed at controlling the number of digits displayed.

`add_header_lines` adds a header to a flextable.

`autofit` is used to automatically adjust flextable height and width to fit the size of desired content.

`is_empty` checks if an object has a value or not. If the value is missing, then we use `add_row` to add the missing permit type.

`tm_shape` creates a tmap-element that draws polygons.

`tm_fill` fills map shapes based on what you want. You can either choose a fixed color or map create a color palette mapped to a variable.

`tm_borders` adds borders to a map shape

`tm_credits` adds map credits.

`tm_bubbles` creates bubbles. This is how we represent crime points on a map.

`tm_layout` specifies map layout. Used for controlling/creating map legend

`tmap_save` saves a tmap object.

`ggsave` saves a ggplot object.

`theme` is a ggplot function that allows you to control the non-data parts of your plot (i.e. title, labels, fonts, etc.)

`convert_to_pdf` uses libreOffice (another application) to convert the saved powerpoint into a PDF.

`ggplot` initializes a ggplot object. Can be used to specify the data frame and the plot aesthetics.

`geom_bar` creates a bar plot in a ggplot object

`geom_text` is used to place text in a ggplot object. It is used in this notebook to label the stacked bar chart values that are greater than a certain amount.

`coord_flip` flips the x and the y axis in ggplot.

`scale_colour_manual` used to assign specific color values to ggplot. This references the `cols` vector to make sure that symbology is consistent throughout the report.

`xlab` `ylab` creates axis labels in a ggplot object.

`unique` returns all unique values in a given vector. It is used in the `for` loop of this notebook to extract the neighborhood name in each iteration of the loop.

`comment` adds a comment to any R object. It is used in this notebook to add the neighborhood name to the basemap tiles. This helps the `for` loop run more efficiently.

`min` returns the minimum value in a vector.

`max` returns the maximum value in a vector.

`median` returns the median value of a vector.

`mean` returns the mean average of a vector.

`sum` returns the total sum of a vector

`currency` formats values as currency.

`is.infinite` checks if a value is infinite or not. It is used in the summary notes to identify whether a perentage change is infinite or not, i.e. dividing a number by 0.

`is.nan` is used to check if a value is NA or not. It is used in the summary notes to identify NA values, which are instances where mathematic operations cannot apply, i.e. when there are no building permits and ergo no values to perform such operations.

`percent` formats values as a percentage

`as.numeric` formats values as numberic.

`summarise` or `summarize` are used in conjunction with `group_by` to create an output that has one row for each group specified in the `summarise` function.

`set_header_lables` allows you to change column names in a flextable.

`st_as_sf` converts an object into a simple feature object.

`st_transform` transforms or converts the coordinates of a simple feature object.

`dollar_format` is used with ggplot to represent values in dollar format.

`st_write` writes a simple feature to a file or database.

`st_read` reads a simple feature from a file or databease.

`scale_y_continuous` is used to set y axis labels. Used with `dollar_format` in order to format y axis labels in dollar format.

`gw_get_data` is from the `Gateway` package which is specifically used for accessing St. Louis City data.

`merge` combines two datasets by a certain variable.

```{r, include=FALSE}
#import parcel data
st_read(here::here("data", "working-db", "parcels", "prcl.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> prcl
```

```{r, include=FALSE}
#make sure both are numeric
df$HANDLE <- as.numeric(df$HANDLE)
prcl$HANDLE <- as.numeric(prcl$HANDLE)

#merge by handle
merge <- df%>%
  merge(prcl, by = "HANDLE")
```

```{r}
#create custom color palette for plots
cols <- c("Industrial" = "#e41a1c", "Residential" = "#377eb8", "Commercial" = "#4daf4a", "Institutional" = "#984ea3")

# summary note colors
reg24 <- fp_text(color = 'black', font.size = 24)
reg20 <- fp_text(color = 'black', font.size = 20)
boldline <- fp_text(color = "black", font.size = 28, bold = TRUE, underlined = TRUE)
bold <- fp_text(color = "black", font.size = 24, bold = TRUE)
```

```{r officer layout}
#create custom powerpoint layout
lay <- lay_new(matrix(1:2)) 
title <- lay_new(1, widths = 2, heights = 2)
layout <- lay_bind_row(title, lay, heights = c(1,6))
lay_show(layout)

offlayout <- phl_layout(layout,
    margins = c(0.25, 0.25, 0.25, 0.25),
    innerMargins = rep(0.15,4))

lay1 <- lay_new(matrix(1:4, nc = 2), widths = c(2,2), heights = c(2,1)) 
title1 <- lay_new(1, widths = 2, heights = 2)
layout1 <- lay_bind_row(title1, lay1, heights = c(1,6))
lay_show(layout1)

offlayout01 <- phl_layout(layout1,
    margins = c(0, 0, 0, 0),
    innerMargins = rep(0.15,4))
```

```{r}
# All Neighborhood Building Permit Map
merge_sf <- st_as_sf(merge)

bound%>%
filter(NHD_NUM %in% nbhd_num) -> bound_sub

#inset map
bound%>%
tm_shape()+
  tm_fill(col = "grey")+
  tm_borders(col = "white")+
  bound_sub%>%
  tm_shape()+
  tm_fill(col = "forestgreen")+
  tm_borders(col = "white") -> inset

bound_sub%>%
tm_shape()+
  tm_fill(col = "grey")+
  tm_borders(col = "white")+
  merge_sf%>%
  tm_shape() +
  tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("Source: City of St. Louis", position = c("left", "BOTTOM"), size = .5) +
    tm_credits(paste("Date Created:", Sys.Date()), position = c("right", "BOTTOM"), size = .5)+
  tm_layout(
    main.title = paste("St. Louis Central Corridor West\nBuilding Permits -", params$year),
    main.title.position = "center",
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))-> map

tmap_save(map, insets_tm = inset, insets_vp = viewport(0.8, 0.75, width = 0.4, height = 0.4), file = here::here("results", params$year, "yearly", "all_nbhds", "allbldg_map.jpeg"), width = 10.5, height = 5.9, units = "in")
```


```{r}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "St. Louis Central Corridor West Building Permits", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(paste("Monthly Report:", params$year, sep = " "), location = ph_location_type(type = "subTitle"))%>%
  ph_with(value = "Washington University Medical Center", location = ph_location_type(type = "dt")) -> report

#add STL map reference
report%>%
add_slide()%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "spat_ref.png"), height = 5, width = 9),
          ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("St. Louis Neighborhood Spatial Reference", 
               location = ph_location_type(
                 type = "title") )-> report
```

#5 Year Analysis
```{r}
yr5%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  theme(axis.title.x = element_blank()) +
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "all_nbhds", "5yr_plot.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "all_nbhds", "5yr_plot.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
```

### All Neighborhoods: Summary

```{r}
# Average cost by neighborhood for each `new_use`

ggplot(means, aes(x = nbhd_name, y = mean, fill = new_use)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(position = "dodge", stat="identity") +
  theme(plot.title = element_text(hjust = 0.5),
    axis.title.y = element_blank()) +
  ylab("Cost") +
  labs(fill = "New Use") +
  scale_y_continuous(labels = scales::dollar_format())+
  coord_flip()

ggsave(here::here("results", params$year, "yearly", "all_nbhds", "allnbhd_plot.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "all_nbhds", "allnbhd_plot.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Neighborhood Summary: Average Building Permit Cost", 
               location = ph_location_type(
                 type = "title") )-> report

```

```{r, echo = FALSE}
#create summary tables for current year and last year
df%>%
  group_by(nbhd_name)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(nbhd_name, mean, count, sum) -> table

names[!(names %in% table$nbhd_name)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, nbhd_name = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., nbhd_name) -> table

  
lastyr%>%
  group_by(nbhd_name)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(nbhd_name, mean, count, sum) -> table1

names[!(names %in% table1$nbhd_name)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, nbhd_name = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., nbhd_name) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(nbhd_name = "Neighborhood", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(nbhd_name = "Neighborhood", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide()%>%
  ph_with("Neighborhood Summary", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 4, flex01) -> report
```


### Forest Park Southeast

```{r FPSE Density Map Prep, include = FALSE}
merge_sf %>%
  filter(Nbrhd == 39) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = fpse) -> fpse_densities

fpse_den_tm <- tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(fpse_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Building Permits Per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(fpse_den_tm, file = here("results", params$year, "yearly", "fpse", "fpse_density.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "fpse", "fpse_density.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Forest Park Southeast: Building Permit Density Map",
               location = ph_location_type(
                 type = "title") )-> report
```

```{r}
if("Forest Park Southeast" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Forest Park Southeast")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "fpse", "fpse5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "fpse", "fpse5yr.png"), 
                       width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Forest Park Southeast 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 39)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "fpse.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Forest Park Southeast", 
               location = ph_location_type(
                 type = "title") )-> report
```


```{r FPSE ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Forest Park Southeast: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create fpse color palette
sub <- filter(df, nbhd_name == "Forest Park Southeast")
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r FPSE Building Permit Mapping, include = FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){

#write shapefile
fpse_shp <- filter(merge, nbhd_name == "Forest Park Southeast")
st_write(fpse_shp, here::here("data", params$year, "yearly", "shapefiles", "fpse.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "fpse.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> fpse

#mapping
tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  fpse%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> fpse_map

#save map as .jpeg
tmap_save(fpse_map, file = here::here("results", params$year, "yearly", "fpse", "fpse_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "fpse", "fpse_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Forest Park Southeast", 
               location = ph_location_type(
                 type = "title") )-> report
  }
```

```{r FPSE summary table, echo=FALSE}
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Forest Park Southeast")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Forest Park Southeast")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Neighborhood Summary", 
               location = ph_location_type(
                 type = "title")) -> report
```

```{r, echo=FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 39,]) < 15){
    
    #create in depth summary table
  df%>%
  filter(nbhd_name == "Forest Park Southeast")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "address")%>%
    set_caption("Forest Park Southeast Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Forest Park Southeast Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r fpse plot, echo=FALSE, message=FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){
fpse <- filter(df, nbhd_name == "Forest Park Southeast")
ggplot(fpse, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> fpse_plot

ggsave(here::here("results",  params$year, "yearly", "fpse", "fpse_cost.png"), 
       plot = fpse_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "fpse", "fpse_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE)%>%
  ph_with(value = "Forest Park Southeast Permit Cost Breakdown", 
          location = ph_location_type(type = "title")) -> report
}
```

### Central West End

```{r}
if("Central West End" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Central West End")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "cwe", "cwe5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "cwe", "cwe5yr.png"), 
                       width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Central West End 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 38)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "cwe.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Central West End", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r CWE ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Central West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create cwe color palette
sub <- filter(df, nbhd_name == "Central West End")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r CWE Building Permit Mapping, include = FALSE}

if("Central West End" %in% df$nbhd_name){

#write shapefile  
cwe_shp <- filter(merge, nbhd_name == "Central West End")
st_write(cwe_shp, here::here("data", params$year, "yearly", "shapefiles", "cwe.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "cwe.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> cwe

#map shapefile
tm_shape(cwe_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 38) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  cwe%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> cwe_map

#save map as .jpeg
tmap_save(cwe_map, file = here::here("results", params$year, "yearly", "cwe", "cwe_use.jpeg"),
          width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "cwe", "cwe_use.jpeg"), width = 9, height = 5), location = ph_location_type(type="body"), use_loc_size = FALSE)%>%
  ph_with("Central West End", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("Central West End" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Central West End")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table

  
lastyr%>%
  filter(nbhd_name == "Central West End")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Central West End", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r CWE summary table, echo = FALSE}
if("Central West End" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 38,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Central West End")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "address")%>%
    set_caption("Central West End Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Central West End Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r CWE plot, echo=FALSE, message=FALSE}
if("Central West End" %in% df$nbhd_name){
cwe <- filter(df, nbhd_name == "Central West End")
ggplot(cwe, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> cwe_plot

ggsave(here::here("results",  params$year, "yearly", "cwe", "cwe_cost.png"), 
       plot = cwe_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Cental West End Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "cwe", "cwe_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### DeBaliviere Place

```{r}
if("DeBaliviere Place" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "DeBaliviere Place")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "dbplace", "dbplace5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "dbplace", "dbplace5yr.png"), 
                       width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 47)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "dbplace.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("DeBaliviere Place", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r dbplace ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "DeBaliviere Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create DeBaliviere Place color palette
sub <- filter(df, nbhd_name == "DeBaliviere Place")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r DeBaliviere Place Building Permit Mapping, include = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){

#write shapefile  
dbplace_shp <- filter(merge, nbhd_name == "DeBaliviere Place")
st_write(dbplace_shp, here::here("data", params$year, "yearly", "shapefiles", "dbplace.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "dbplace.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> dbplace

#map shapefile
tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  dbplace%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> dbplace_map

#save map as .jpeg
tmap_save(dbplace_map, file = here::here("results", params$year, "yearly", "dbplace", "dbplace_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "dbplace", "dbplace_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table

  
lastyr%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("DeBaliviere Place", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r dbplace summary table, echo = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 47,]) < 15){
    
  #create in depth summary table
  df%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("DeBaliviere Place Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "DeBaliviere Place Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r dbplace plot, echo=FALSE, message=FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
dbplace <- filter(df, nbhd_name == "DeBaliviere Place")
ggplot(dbplace, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> dbplace_plot

ggsave(here::here("results",  params$year, "yearly", "dbplace", "dbplace_cost.png"), 
       plot = dbplace_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "DeBaliviere Place Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "dbplace", "dbplace_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Skinker DeBaliviere

```{r}
if("Skinker DeBaliviere" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Skinker DeBaliviere")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "skinker", "skinker5yr.png"),
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "skinker", "skinker5yr.png"), 
                       width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 46)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "skinker.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Skinker DeBaliviere", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r skinker ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Skinker DeBaliviere: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create Skinker DeBaliviere color palette
sub <- filter(df, nbhd_name == "Skinker DeBaliviere")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Skinker DeBaliviere Building Permit Mapping, include = FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){

#write shapefile
skinker_shp <- filter(merge, nbhd_name == "Skinker DeBaliviere")
st_write(skinker_shp, here::here("data", params$year, "yearly", "shapefiles", "skinkerdb.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "skinkerdb.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> skinker

#mapping
tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  skinker%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> skinker_map

#save map as .jpeg
tmap_save(skinker_map, file = here::here("results", params$year, "yearly", "skinker", "skinker_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "skinker", "skinker_use.jpeg"), width = 9, height = 5), 
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Skinker DeBaliviere summary table, echo = FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table

  
lastyr%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Skinker DeBaliviere", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r, echo=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 46,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)

#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Skinker DeBaliviere Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Skinker DeBaliviere Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r skinker plot, echo=FALSE, message=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
skinker <- filter(df, nbhd_name == "Skinker DeBaliviere")
ggplot(skinker, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> skinker_plot

ggsave(here::here("results",  params$year, "yearly", "skinker", "skinker_cost.png"),
       plot = skinker_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Skinker DeBaliviere Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "skinker", "skinker_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### West End

```{r}
if("West End" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "West End")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "westend", "westend5yr.png"),
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "westend", "westend5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 48)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "westend.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("West End", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r West End ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

```{r}
#create West End color palette
sub <- filter(df, nbhd_name == "West End")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r West End Building Permit Mapping, include = FALSE}

if("West End" %in% df$nbhd_name){

#write shapefile
westend_shp <- filter(merge, nbhd_name == "West End")
st_write(westend_shp, here::here("data", params$year, "yearly", "shapefiles", "westend.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "westend.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> westend

#mapping
tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  westend%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> westend_map

#save map as .jpeg
tmap_save(westend_map, file = here::here("results", params$year, "yearly", "westend", "westend_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "westend", "westend_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r West End summary table, echo=FALSE}
if("West End" %in% df$nbhd_name){
  
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "West End")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "West End")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("West End", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r West End summary table, echo=FALSE}
if("West End" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 48,]) < 15){

    #create in depth summary table
  df%>%
  filter(nbhd_name == "West End")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("West End Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "West End Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r westend plot, echo=FALSE, message=FALSE}
if("West End" %in% df$nbhd_name){
westend <- filter(df, nbhd_name == "West End")
ggplot(westend, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> westend_plot

ggsave(here::here("results",  params$year, "yearly", "westend", "westend_cost.png"), 
       plot = westend_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "West End Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
 ph_with(external_img(here::here("results", params$year, "yearly", "westend", "westend_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Visitation Park

```{r}
if("Visitation Park" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Visitation Park")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "vstprk", "vstprk5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vstprk", "vstprk5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 49)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "vstprk.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Visitation Park", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r vstprk ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Visitation Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

```{r}
#create Visitation Park color palette
sub <- filter(df, nbhd_name == "Visitation Park")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Visitation Park Building Permit Mapping, include = FALSE}
if("Visitation Park" %in% df$nbhd_name){
  
#write shapefile
visit_shp <- filter(merge, nbhd_name == "Visitation Park")
st_write(visit_shp, here::here("data", params$year, "yearly", "shapefiles", "vstprk.shp"), 
         delete_dsn = TRUE)
  
#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "vstprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vstprk

#map shapefile
tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vstprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vstprk_map

#save map as .jpeg
tmap_save(vstprk_map, file = here::here("results", params$year, "yearly", "vstprk", "vstprk_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vstprk", "vstprk_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo = FALSE}
if("Visitation Park" %in% df$nbhd_name){
    
 #create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Visitation Park")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Visitation Park")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Visitation Park", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r, echo=FALSE}
if("Visitation Park" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 49,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Visitation Park")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Visitation Park Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Visitation Park Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r vstprk plot, echo=FALSE, message=FALSE}
if("Visitation Park" %in% df$nbhd_name){
vstprk <- filter(df, nbhd_name == "Visitation Park")
ggplot(vstprk, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vstprk_plot

ggsave(here::here("results",  params$year, "yearly", "vstprk", "vstprk_cost.png"), 
       plot = vstprk_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Visitation Park Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vstprk", "vstprk_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Academy

```{r}
if("Academy" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Academy")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "academy", "ac5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "academy", "ac5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Academy 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 51)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "academy.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Academy", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r Academy ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Academy: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create Academy color palette
sub <- filter(df, nbhd_name == "Academy")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Academy Building Permit Mapping, include = FALSE}
if("Academy" %in% df$nbhd_name){
  
#write shapefile  
  academy_shp <- filter(merge, nbhd_name == "Academy")
  st_write(academy_shp, here::here("data", params$year, "yearly", "shapefiles", "academy.shp"), 
         delete_dsn = TRUE)


#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "academy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> academy

#tm mapping
tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  academy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> academy_map

#save map as .jpeg
tmap_save(academy_map, file = here::here("results", params$year, "yearly", "academy", "ac_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "academy", "ac_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Academy", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Academy summary table, echo = FALSE}
if("Academy" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Academy")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Academy")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Academy", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r Academy summary table, echo=FALSE}
if("Academy" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 51,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Academy")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Academy Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Academy Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r Academy plot, echo=FALSE, message=FALSE}
if("Academy" %in% df$nbhd_name){
academy <- filter(df, nbhd_name == "Academy")
ggplot(academy, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ac_plot

ggsave(here::here("results",  params$year, "yearly", "academy", "ac_cost.png"), 
       plot = ac_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Academy Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "academy", "ac_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Fountain Park

```{r}
if("Fountain Park" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Fountain Park")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "ftnprk", "ftnprk5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "ftnprk", "ftnprk5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 53)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "ftnprk.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Fountain Park", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r ftnprk ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Fountain Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

```{r}
#create Fountain Park color palette
sub <- filter(df, nbhd_name == "Fountain Park")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Fountain Park Building Permit Mapping, include = FALSE}
if("Fountain Park" %in% df$nbhd_name){

#write shapefile
ftnprk_shp <- filter(merge, nbhd_name == "Fountain Park")
st_write(ftnprk_shp, here::here("data", params$year, "yearly", "shapefiles", "ftnprk.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "ftnprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> ftnprk

#map shapefile
tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  ftnprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> ftnprk_map

#save map as .jpeg
tmap_save(ftnprk_map, file = here::here("results", params$year, "yearly", "ftnprk", "ftnprk_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "ftnprk", "ftnprk_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Fountain Park summary table, echo = FALSE}
if("Fountain Park" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Fountain Park")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Fountain Park")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Fountain Park", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r, echo=FALSE}
if("Fountain Park" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 53,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Fountain Park")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Fountain Park Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Fountain Park Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r ftnprk plot, echo=FALSE, message=FALSE}
if("Fountain Park" %in% df$nbhd_name){
ftnprk <- filter(df, nbhd_name == "Fountain Park")
ggplot(ftnprk, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ftnprk_plot

ggsave(here::here("results",  params$year, "yearly", "ftnprk", "ftnprk_cost.png"), 
       plot = ftnprk_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Fountain Park Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "ftnprk", "ftnprk_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Lewis Place

```{r}
if("Lewis Place" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Lewis Place")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "lewis", "lewis5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "lewis", "lewis5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 54)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "lewis.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Lewis Place", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r Lewis Place ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Lewis Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

```{r}
#create Lewis Place color palette
sub <- filter(df, nbhd_name == "Lewis Place")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Lewis Place Building Permit Mapping, include = FALSE}

if("Lewis Place" %in% df$nbhd_name){

#write shapefile
lewis_shp <- filter(merge, nbhd_name == "Lewis Place")
st_write(lewis_shp, here::here("data", params$year, "yearly", "shapefiles", "lewis.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "lewis.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> lewis

#map shapefile
tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  lewis%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> lewis_map

#save map as .jpeg
tmap_save(lewis_map, file = here::here("results", params$year, "yearly", "lewis", "lewis_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "lewis", "lewis_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("Lewis Place" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Lewis Place")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Lewis Place")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Lewis Place", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r, echo=FALSE}
if("Lewis Place" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 54,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Lewis Place")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Lewis Place Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Lewis Place Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r Lewis plot, echo=FALSE, message=FALSE}
if("Lewis Place" %in% df$nbhd_name){
lewis <- filter(df, nbhd_name == "Lewis Place")
ggplot(lewis, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> lewis_plot

ggsave(here::here("results",  params$year, "yearly", "lewis", "lewis_cost.png"), 
       plot = lewis_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Lewis Place Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "lewis", "lewis_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"),
                       use_loc_size = FALSE) -> report
}
```

### Vandeventer

```{r}
if("Vandeventer" %in% df$nbhd_name){
year <- filter(yr5, nbhd_name == "Vandeventer")
year%>%
  group_by(yr)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(yr, mean, count) -> yr

yr$mean <- currency(yr$mean, digits = 0L)

ggplot(data = yr, aes(x = yr, y = count))+
  geom_point()+
  geom_line()+
  theme(
    axis.title.x = element_blank())+
  geom_label_repel(aes(label = mean),
                  box.padding   = 0.35, 
                  segment.color = 'grey50')+
  ylab("Number of Building Permits")+
  labs(caption = "Values shown represent the average building permit cost for a given year")

# save plot
ggsave(here::here("results", params$year, "yearly", "vandy", "vandy5yr.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vandy", "vandy5yr.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer 5 Year Analysis", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r}
#create mean, median, range stats
nbhd20 <- filter(df, Nbrhd == 58)
mean <- mean(nbhd20$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(nbhd20$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(nbhd20$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(nbhd20$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste(params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "vandy.png"), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with("Vandeventer", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r vandy ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyr, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in %s",
                    bp20, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to ", " ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to ", " ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Vandeventer: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report
```

```{r}
#create Vandeventer color palette
sub <- filter(df, nbhd_name == "Vandeventer")
#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}
```

```{r Vandeventer Building Permit Mapping, include = FALSE}
if("Vandeventer" %in% df$nbhd_name){
  
#write shapefile
vandy_shp <- filter(merge, nbhd_name == "Vandeventer")
st_write(vandy_shp, here::here("data", params$year, "yearly", "shapefiles", "vandy.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, "yearly", "shapefiles", "vandy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vandy

#mapping
tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vandy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vandy_map

#save map as .jpeg
tmap_save(vandy_map, file = here::here("results", params$year, "yearly", "vandy", "vandy_use.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vandy", "vandy_use.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r vandy summary table, echo=FALSE}
if("Vandeventer" %in% df$nbhd_name){
    
#create summary tables for current month and past 6 months
df%>%
  filter(nbhd_name == "Vandeventer")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table

  
lastyr%>%
  filter(nbhd_name == "Vandeventer")%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

#make a currency value
table$mean <- currency(table$mean, digits = 0L)
table1$mean <- currency(table1$mean, digits = 0L)
table$sum <- currency(table$sum, digits = 0L)
table1$sum <- currency(table1$sum, digits = 0L)
  
#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste(params$year))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste(params$pastyear))%>%
  set_header_labels(new_use = "Permit Use", 
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with("Vandeventer", 
               location = ph_location_type(
                 type = "title")) -> report
}
```

```{r, echo=FALSE}
if("Vandeventer" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 58,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Vandeventer")%>%
    dplyr::select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Vandeventer Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Vandeventer Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r vandy plot, echo=FALSE, message=FALSE}
if("Vandeventer" %in% df$nbhd_name){
vandy <- filter(df, nbhd_name == "Vandeventer")
ggplot(vandy, aes(lrgcost)) +
  scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vandy_plot

ggsave(here::here("results",  params$year, "yearly", "vandy", "vandy_cost.png"), 
       plot = vandy_plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = "Vandeventer Permit Cost Breakdown", location = ph_location_type(type = "title"))%>%
  ph_with(external_img(here::here("results", params$year, "yearly", "vandy", "vandy_cost.png"),
                       width = 9, height = 5), location = ph_location_type(type = "body"), 
                       use_loc_size = FALSE) -> report
}
```

```{r}
  # additional notes slide
report%>%
  add_slide()%>%
  ph_with(value = "Additional Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c("Data retreived from https://www.stlouis-mo.gov/data/", "Building permits with a cost of $0 were dropped", "Building permits that were cancelled were dropped", "Infinite change indicates 0 permits in the current or previous time period/comparison month so there was a overall increase or decrease"), location = ph_location_type(type = "body")) -> report
```


```{r}
# save powerpoint report
print(report, target = here::here("results", "presentations",  params$year, "yearly", paste("bldgprmt_report", params$year, ".pptx", sep = "")))

#delete any existing fpse-bot-cwe-mc file in the Shiny app
mydir <- "/Users/loganbogenut/Documents/GitHub/crime_interactive/crime_interactive/www/"
file.remove(file.path(mydir, dir(path = mydir, pattern = "monthly_report")))

#convert & save powerpoint as PDF to Shiny app
convert_to_pdf(path = here::here("results", "presentations", params$year, "yearly", paste("bldgprmt_report", params$year, ".pptx", sep = "")),
               pdf_file = sub("[.]pptx", ".pdf", paste("~/Documents/GitHub/crime_interactive/crime_interactive/www/", "bldgprmt_report", params$year, ".pptx", sep = "")))

# This code cleans our Global Environment and gives you a nice lil' message

rm(list = ls())
print("NICE JOB! You successfully ran all your code. Have an awesome day :)")
```


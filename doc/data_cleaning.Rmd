---
title: "data_cleaning"
author: "Logan Williams"
date: "2/24/2020"
output: html_document
params:
  
  #Change Every month
  month: December
  pastyear: 2019
  year: 2020 
                 
  # Compiles Year to Date Dataset for this year | Leave at January 1st 2020
  ytd: "2020-01-01" 
               
  # First day of current month | Change this each month
  date: "2020-12-01"   
  
  # First day of next month | Change this each month
  enddate: "2021-01-01"
           
  #Leave at January 1st of last year | Compiles Year to Date Dataset for previous year
  pastdate: "2019-01-01" 
            
  # First day of the month from LAST YEAR | Compiles Data for the most recent month of the previous year
  pstmonth: "2019-12-01" 
           
  # This is the first day of the next month (of last year) | Compiles Data for the most recent month of the previous year
  pstmonth2: "2020-01-01"  
  
    #6 Months prior to params$date
  month6: "2020-07-01"
  
  #Quarterly Report Data only needs to be updated once every quarter. Quarter data for current year and previous year for comparison
  #start of quarter
  qrtstart: "2020-10-01"
  qrtstart2: "2019-10-01"
  
  #end of quarter
  qrtend: "2020-12-31"
  qrtend2: "2019-12-31"
  
  #Quarter
  quarter: 4
---

### Introduction

This file is used to clean data from the city of St Louis and convert it into a .csv file which will be stored in my `data` folder. This file is complied by Logan Williams for use by the WUMCRC.

## Dependencies

```{r, message=FALSE}

#Load dependencies

library(dplyr)        #data cleaning
library(RODBC)        #ODBC database connectivity
library(ggplot2)      #chart making
library(here)         #file paths
library(readr)        #Write csv
library(writexl)      #write excel
library(lubridate)    #manipulate date time data
```

#Function References

`dir.create` creates a new folder in a specified location, often using the `here` function from the `here` package to specify the desired location.

`here` is a function from the `here` package that is used for file path referencing. It specifically directs you to your current working directory.

`getwd` gives you your current working directory.

`file.path` constructs file paths in a platform independent way.

`filter` is a dplyr function that is used to clean data. Specifically it is used to find rows/cases where a condition is true. If the condition is true then the values are kept, if not they are dropped.

`group_by` takes an existing tbl and converts it into a grouped tbl based on a specific variable.

`rename` does exactly what you think it does. It renames variables based on name.

`replace` replaces a certain value with another. It is used in this notebook to replace NAs with 0.

`mutate` is used to create a new variable in your data frame.

`ifelse` is a function that provides a condition. If this condition is true, it executes a command, if the condition isn't true it executes a seperate command. It is used in this notebook along with the `mutate` function to create new variables based on existing variables in a dataset.

`grepl` searches for matches to a pattern. It is used in this notebook along with `ifelse` and `mutate` to look for matches to, for example, neighborhood number and then create a variable with the corresponding neighborhood name.

`select` comes from the dplyr package and is used to select variables from a dataset that you wish to keep (it can also be used to remove unwanted variables).

`summarise` is used in conjunction with `group_by` to create an output that has one row for each group specified in the `summarise` function.

`as.Date` converts a specified variable to a date format. This is used in this notebook so that we can filter out observations based on the date they occurred. 

`write_csv` is a function used to write a .csv file from a dataset.

```{r}
# This code chunk creates the appropriate folder paths that are referred to in all of the .Rmd documents. 
# This code is necessary to knit and compile the powerpoint presentations.

here::here()
dir.create(getwd())
dir.create(here::here(file.path("results", params$year)))
dir.create(here::here(file.path("results", params$year, "yearly")))
dir.create(here::here(file.path("results", params$year, "yearly", "academy")))
dir.create(here::here(file.path("results", params$year, "yearly", "cwe")))
dir.create(here::here(file.path("results", params$year, "yearly", "dbplace")))
dir.create(here::here(file.path("results", params$year, "yearly", "ftnprk")))
dir.create(here::here(file.path("results", params$year, "yearly", "fpse")))
dir.create(here::here(file.path("results", params$year, "yearly", "lewis")))
dir.create(here::here(file.path("results", params$year, "yearly", "skinker")))
dir.create(here::here(file.path("results", params$year, "yearly", "vandy")))
dir.create(here::here(file.path("results", params$year, "yearly", "vstprk")))
dir.create(here::here(file.path("results", params$year, "yearly", "westend")))
dir.create(here::here(file.path("results", params$year, "yearly", "all_nbhds")))
dir.create(here::here(file.path("results", params$year, params$month)))
dir.create(here::here(file.path("results", params$year, params$month, "academy")))
dir.create(here::here(file.path("results", params$year, params$month, "cwe")))
dir.create(here::here(file.path("results", params$year, params$month, "dbplace")))
dir.create(here::here(file.path("results", params$year, params$month, "ftnprk")))
dir.create(here::here(file.path("results", params$year, params$month, "fpse")))
dir.create(here::here(file.path("results", params$year, params$month, "lewis")))
dir.create(here::here(file.path("results", params$year, params$month, "skinker")))
dir.create(here::here(file.path("results", params$year, params$month, "vandy")))
dir.create(here::here(file.path("results", params$year, params$month, "vstprk")))
dir.create(here::here(file.path("results", params$year, params$month, "westend")))
dir.create(here::here(file.path("results", params$year, params$month, "all_nbhds")))
dir.create(here::here(file.path("results", "presentations", params$year, params$month)))
dir.create(here::here(file.path("results", "presentations", params$year, "yearly")))
dir.create(here::here(file.path("results", "presentations", params$year, "quarterly")))
dir.create(here::here(file.path("data", params$year)))
dir.create(here::here(file.path("data", params$year, params$month)))
dir.create(here::here(file.path("data", params$year, params$month, "shapefiles")))
dir.create(here::here(file.path("data", params$year, "yearly")))
dir.create(here::here(file.path("data", params$year, "yearly", "shapefiles")))
dir.create(here::here(file.path("data", params$year, "quarterly")))
dir.create(here::here(file.path("data", params$year, "quarterly", "1")))
dir.create(here::here(file.path("data", params$year, "quarterly", "2")))
dir.create(here::here(file.path("data", params$year, "quarterly", "3")))
dir.create(here::here(file.path("data", params$year, "quarterly", "4")))
dir.create(here::here(file.path("results", params$year, "quarterly")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "academy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "cwe")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "dbplace")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "ftnprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "fpse")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "lewis")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "skinker")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "vandy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "vstprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "westend")))
dir.create(here::here(file.path("results", params$year, "quarterly", "1", "all_nbhds")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "academy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "cwe")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "dbplace")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "ftnprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "fpse")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "lewis")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "skinker")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "vandy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "vstprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "westend")))
dir.create(here::here(file.path("results", params$year, "quarterly", "2", "all_nbhds")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "academy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "cwe")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "dbplace")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "ftnprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "fpse")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "lewis")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "skinker")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "vandy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "vstprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "westend")))
dir.create(here::here(file.path("results", params$year, "quarterly", "3", "all_nbhds")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "academy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "cwe")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "dbplace")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "ftnprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "fpse")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "lewis")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "skinker")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "vandy")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "vstprk")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "westend")))
dir.create(here::here(file.path("results", params$year, "quarterly", "4", "all_nbhds")))
```

### Temporary Code
```{r, message=FALSE}
library(readxl)
data <- read_excel(here::here("data", "PrmBldg.xlsx"))
```


```{r, include=FALSE}
# Set working directory
wd <- getwd()
setwd(wd)
#setwd("G:/Projects/Monthly-Reports/stl-building-permits")
```

### Actual code for importing data 
```{r, include=FALSE}

#Import data

#channel <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=/data/working-db/bldgpermits/prmdbo
                             #G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning/prmbdo/prmbdo")
```


```{r, include=FALSE}

#Run SQL query to return data

#data <- sqlQuery( channel , paste ("select *
# from PrmBldg"))
```


```{r, include=FALSE}
data%>%
  
  #create year & month variables
  mutate(yr = format(as.Date(data$FirstDate,  format="%d/%m/%Y"), "%Y"))%>%
  mutate(month = format(as.Date(data$FirstDate, format="%d/%m/%Y"), "%m"))%>%
  
  # Use filter command to filter out permits without a cancellation date and with cost of $0
  filter(is.na(CancelDate))%>%
  filter(EstProjectCost != 0)%>% 

  # Filter out 10 neighborhoods we want to study
  filter(Nbrhd %in% c("38", "39", "46", "47", "48", "49", "51", "53", "54", "58"))%>%
  
  
  # Recode values to neighborood names
  mutate(nbhd_name = ifelse(grepl("38", Nbrhd), "Central West End",
                                             ifelse(grepl("39", Nbrhd), "Forest Park Southeast",
                                             ifelse(grepl("46", Nbrhd), "Skinker DeBaliviere",  
                                             ifelse(grepl("47", Nbrhd), "DeBaliviere Place",
                                             ifelse(grepl("48", Nbrhd), "West End",
                                             ifelse(grepl("49", Nbrhd), "Visitation Park",       
                                             ifelse(grepl("51", Nbrhd), "Academy",       
                                             ifelse(grepl("53", Nbrhd), "Fountain Park",       
                                             ifelse(grepl("54", Nbrhd), "Lewis Place",       
                                             ifelse(grepl("58", Nbrhd), "Vandeventer", NA)))))))))))%>%
  
  #create new_use variable
  mutate(new_use = ifelse(grepl("R2", NewUseGroup1), "Residential",
                                             ifelse(grepl("R3", NewUseGroup1), "Residential",
                                             ifelse(grepl("A2", NewUseGroup1), "Commercial",
                                             ifelse(grepl("A3", NewUseGroup1), "Commercial",
                                             ifelse(grepl("R1", NewUseGroup1), "Commercial",  
                                             ifelse(grepl("B", NewUseGroup1), "Institutional",
                                             ifelse(grepl("M", NewUseGroup1), "Commercial",
                                             ifelse(grepl("E", NewUseGroup1), "Institutional",       
                                             ifelse(grepl("I2", NewUseGroup1), "Institutional", 
                                             ifelse(grepl("I4", NewUseGroup1), "Institutional",
                                             ifelse(grepl("F1", NewUseGroup1), "Commercial",
                                             ifelse(grepl("U", NewUseGroup1), "Commercial",
                                             ifelse(grepl("A1", NewUseGroup1), "Commercial",        
                                             ifelse(grepl("S2", NewUseGroup1), "Commercial",
                                             ifelse(grepl("RESTAURANT", NewUse), "Commercial",
                                             ifelse(grepl("COMM/RESIDENT", NewUse), "Residential",
                                             ifelse(grepl("EVENT SPACE", NewUse), "Commercial",   
                                             ifelse(grepl("CHURCH", NewUse), "Institutional",
                                             ifelse(grepl("WAREHOUSE", NewUse), "Industrial",
                                             ifelse(grepl("PARKING GARAGE", NewUse), "Commercial",
                                             ifelse(grepl("PARKING LOT", NewUse), "Commercial",
                                             ifelse(grepl("CAFE", NewUse), "Commercial",
                                             ifelse(grepl("LOUNGE", NewUse), "Commercial",
                                             ifelse(grepl("NURSING HOME", NewUse), "Residential",
                                             ifelse(grepl("SINGLE FAMILY", NewUse), "Residential",
                                             ifelse(grepl("INGROUND POOL", NewUse), "Commercial",
                                             ifelse(grepl("AUTO BODY", NewUse), "Commercial",
                                             ifelse(grepl("STORAGE", NewUse), "Commercial",
                                                    NA)))))))))))))))))))))))))))))%>%
  
  # Create New Variables for Building Permits Greater/Less Than 50,000
  mutate(big_cost = ifelse(EstProjectCost >= 50000, 1, NA))%>%
  mutate(lil_cost = ifelse(EstProjectCost < 50000, 1, NA))%>%

  #This variable is specifically for individual neighborhood analysis
  mutate(lrgcost = ifelse(grepl("1", big_cost), "> $50,000", "< $50,000"))%>% 
  
  #create count variable
  group_by(nbhd_name, new_use)%>%
  mutate(count = n())%>%
  
  #rename handle
  rename(HANDLE = Handle)%>%
  mutate(abbr = ifelse(grepl("38", Nbrhd), "cwe",
                                             ifelse(grepl("39", Nbrhd), "fpse",
                                             ifelse(grepl("46", Nbrhd), "skinker",  
                                             ifelse(grepl("47", Nbrhd), "dbplace",
                                             ifelse(grepl("48", Nbrhd), "westend",
                                             ifelse(grepl("49", Nbrhd), "vstprk",       
                                             ifelse(grepl("51", Nbrhd), "academy",       
                                             ifelse(grepl("53", Nbrhd), "ftnprk",       
                                             ifelse(grepl("54", Nbrhd), "lewis",       
                                             ifelse(grepl("58", Nbrhd), "vandy", NA)))))))))))%>%
  
  #Drop unused variables using `select` function, assign to new `df` data frame
  dplyr::select(AppType, CancelType, CityBlock, Parcel, OwnerCode, HANDLE, AddrNum,
                    StDir, StName, StType, UnitNum, OrigAddress, ProjectType, MainStrucType, AppDate,
                    IssueDate,CompleteDate, CancelDate, EstProjectCost, AppDescription, StrucType1,
                    NbrOfUnits, NewUse,NewUseGroup1, OldUse, OwnerName, OwnerCo, OwnerAddr, OwnerCity,
                    OwnerState, OwnerZIP, Nbrhd, FirstDate, LastDate, UpDateGeo, count, big_cost, lil_cost, lrgcost, new_use,
                    nbhd_name, yr, month, abbr) -> df
```


```{r}
#write new cleaned data into .csv files

#current month
data_month <- filter(df, FirstDate >= as.Date(params$date) & FirstDate <= as.Date(params$enddate))
write_csv(data_month, here::here("data", params$year, params$month, "clean_data.csv"))

# This code creates a new dataset called `means` that contains a breakdown of building permits by neighborhood broken up by `new_use`. The new dataset contains the `mean` variable which is the mean `EstProjectCost`, a `count1` variable which is simply the number of building permits, a `high_cost` variable which is the number of housing permits whose `EstProjectCost` is greater than or equal to 50,000, and a `low_cost` varaiable which is the number of housing permits whose `EstProjectCost` is less than 50,000.
data_month %>%
  group_by(nbhd_name, new_use) %>%
  summarise(mean = mean(EstProjectCost), count1 = mean(count), high_cost = sum(big_cost, na.rm = TRUE), low_cost = sum(lil_cost, na.rm = TRUE)) -> means
write_csv(means, here::here("data", params$year, params$month, "mean_data.csv"))

#current year to date
data_year <- filter(df, FirstDate >= as.Date(params$ytd) & FirstDate <= as.Date(params$enddate))
write_csv(data_year, here::here("data", params$year, params$month, "ytd.csv"))

#last year this month
lstmonth <- filter(df, FirstDate >= as.Date(params$pstmonth) & FirstDate <= as.Date(params$pstmonth2))
write_csv(lstmonth, here::here("data", params$year, params$month, "lastmonth.csv"))

#last year to date
lastytd <- filter(df, FirstDate >= as.Date(params$pastdate) & FirstDate <= as.Date(params$pstmonth2))
write_csv(lastytd, here::here("data", params$year, params$month, "lastytd.csv"))

#last year data
lstyr <- filter(df, yr == params$year)
write_csv(lstyr, here::here("data", params$year, "yearly", "clean_year.csv"))

#6 month data
month6 <- filter(df, FirstDate >= as.Date(params$month6) & FirstDate <= as.Date(params$enddate))
write_csv(month6, here::here("data", params$year, params$month, "month6.csv"))

#Quarterly Data
data_qrt <- filter(df, FirstDate >= as.Date(params$qrtstart) & FirstDate <= as.Date(params$qrtend))
write_csv(data_qrt, here::here("data", params$year, "quarterly", params$quarter, "quarter-data.csv"))

#Last year quarterly data
data_qrt <- filter(df, FirstDate >= as.Date(params$qrtstart2) & FirstDate <= as.Date(params$qrtend2))
write_csv(data_qrt, here::here("data", params$year, "quarterly", params$quarter, "past-qrtr-data.csv"))

#5 year data
yr5 <- filter(df, yr >= (params$year - 4) & yr <= params$year)
write_csv(yr5, here::here("data", params$year, "yearly", "5year.csv"))
```

```{r}
# This code cleans our Global Environment and gives you a nice lil' message

rm(list = ls())
print("Congrats! The code ran and you rock! Have a great day champ :)")
```

---
title: "Interactive_map"
author: "Logan Williams"
date: "6/11/2020"
output: html_document
runtime: shiny
params: 
  date: "2020-03-01"
  enddate: "2020-04-01"
---

# Introduction

This code creates a dataset of ALL St. Louis building permits (dating back to 1991) and then creates an interactive map using Shiny. The longest part of this code, at the moment, is geocoding all of the results (line 141). 

# IMPORTANT:
For quicker run time, filter `df` in any way you choose to reduce the number of observations. This will allow the geocoding function to run faster because of the fewer observations.

```{r}
# load dependencies
library(here)             #filepath management
library(readr)            #read excel
library(dplyr)            #tools for cleaning data
library(leaflet)          #mapping
library(RColorBrewer)     #pretty maps, oh yeah
library(mapview)
library(tidygeocoder)
library(ggmap)
library(censusxy)
library(mapview)
library(tidyr)            #extract geometry
library(shiny)            # create shiny app
library(shinyWidgets)     #month slider
```

```{r, message=FALSE, warning=FALSE}
library(readxl)
data <- read_excel(here::here("data", "PrmBldg.xlsx"))

#data_month <- as_tibble(data_month)
```

```{r}
data%>%
  
  #create year & month variables
  mutate(yr = format(as.Date(data$FirstDate,  format="%d/%m/%Y"), "%Y"))%>%
  mutate(month = format(as.Date(data$FirstDate, format="%d/%m/%Y"), "%m"))%>%
  
  # Use filter command to filter out permits without a cancellation date and with cost of $0
  filter(is.na(CancelDate))%>%
  filter(EstProjectCost != 0)%>% 

  # Filter out 10 neighborhoods we want to study
  filter(Nbrhd %in% c("38", "39", "46", "47", "48", "49", "51", "53", "54", "58"))%>%
  
  
  # Recode values to neighborood names
  mutate(nbhd_name = ifelse(grepl("38", Nbrhd), "Central West End",
                                             ifelse(grepl("39", Nbrhd), "Forest Park Southeast",
                                             ifelse(grepl("46", Nbrhd), "Skinker DeBaliviere",  
                                             ifelse(grepl("47", Nbrhd), "DeBaliviere Place",
                                             ifelse(grepl("48", Nbrhd), "West End",
                                             ifelse(grepl("49", Nbrhd), "Visitation Park",       
                                             ifelse(grepl("51", Nbrhd), "Academy",       
                                             ifelse(grepl("53", Nbrhd), "Fountain Park",       
                                             ifelse(grepl("54", Nbrhd), "Lewis Place",       
                                             ifelse(grepl("58", Nbrhd), "Vandeventer", NA)))))))))))%>%
  
  #create new_use variable
  mutate(new_use = ifelse(grepl("R2", NewUseGroup1), "Residential",
                                             ifelse(grepl("R3", NewUseGroup1), "Residential",
                                             ifelse(grepl("A2", NewUseGroup1), "Commercial",
                                             ifelse(grepl("A3", NewUseGroup1), "Commercial",
                                             ifelse(grepl("R1", NewUseGroup1), "Commercial",  
                                             ifelse(grepl("B", NewUseGroup1), "Institutional",
                                             ifelse(grepl("M", NewUseGroup1), "Commercial",
                                             ifelse(grepl("E", NewUseGroup1), "Institutional",       
                                             ifelse(grepl("I2", NewUseGroup1), "Institutional", 
                                             ifelse(grepl("I4", NewUseGroup1), "Institutional",
                                             ifelse(grepl("F1", NewUseGroup1), "Commercial",
                                             ifelse(grepl("U", NewUseGroup1), "Commercial", 
                                             ifelse(grepl("RESTAURANT", NewUse), "Commercial",
                                             ifelse(grepl("COMM/RESIDENT", NewUse), "Residential",
                                             ifelse(grepl("EVENT SPACE", NewUse), "Commercial",   
                                             ifelse(grepl("CHURCH", NewUse), "Institutional",
                                             ifelse(grepl("WAREHOUSE", NewUse), "Industrial",
                                             ifelse(grepl("PARKING GARAGE", NewUse), "Commercial",
                                             ifelse(grepl("PARKING LOT", NewUse), "Commercial",
                                             ifelse(grepl("CAFE", NewUse), "Commercial",
                                             ifelse(grepl("LOUNGE", NewUse), "Commercial",
                                             ifelse(grepl("NURSING HOME", NewUse), "Residential",
                                                    NA)))))))))))))))))))))))%>%
  
  # Create New Variables for Building Permits Greater/Less Than 50,000
  mutate(big_cost = ifelse(EstProjectCost >= 50000, 1, NA))%>%
  mutate(lil_cost = ifelse(EstProjectCost < 50000, 1, NA))%>%

  #This variable is specifically for individual neighborhood analysis
  mutate(lrgcost = ifelse(grepl("1", big_cost), "> $50,000", "< $50,000"))%>% 
  
  #create month names variable
  mutate(month_name = ifelse(grepl("01", month), "January",
                                             ifelse(grepl("02", month), "February",
                                             ifelse(grepl("03", month), "March",
                                             ifelse(grepl("04", month), "April",
                                             ifelse(grepl("05", month), "May",  
                                             ifelse(grepl("06", month), "June",
                                             ifelse(grepl("07", month), "July",
                                             ifelse(grepl("08", month), "August",       
                                             ifelse(grepl("09", month), "September", 
                                             ifelse(grepl("10", month), "October",
                                             ifelse(grepl("11", month), "November",
                                             ifelse(grepl("12", month), "December", 
                                                    NA)))))))))))))%>%
                                             
  
  #rename handle
  rename(HANDLE = Handle)%>%
  
  #add city and state for geocoding
  mutate(state = "MO")%>%
  mutate(city = "St. Louis")%>%
  
  #Drop unused variables using `select` function, assign to new `df` data frame
  select(OrigAddress,
                    OwnerZIP, Nbrhd, city, state, OrigAddress, CompleteDate, CancelDate, EstProjectCost, 
                    OwnerName, OwnerCo, OwnerAddr, OwnerCity,
                    OwnerState, OwnerZIP, Nbrhd, FirstDate, LastDate, UpDateGeo, count, big_cost, lil_cost, lrgcost, new_use, nbhd_name, yr, month) -> df
```


## Prepare Data for Shiny

```{r}
df <- as_tibble(df)

#geocode results in a dataframe class so that we get lat lon coordinates
geo_df <- cxy_geocode(df, street = 'OrigAddress', city = 'city', state = 'state', zip = 'OwnerZIP', output = "simple", class = "dataframe", return = 'locations')

#remove NAs for now, they mess with the Shiny app output
geo_df <- filter(geo_df, !is.na(geo_df$cxy_lat))
geo_df <- filter(geo_df, !is.na(geo_df$new_use))


#convert to factor not sure if we need this? Pretty sure all input variables need to be characters (as of right now. Once I add sliders this might change)
#geo_df <- as.data.frame((geo_df))
#geo_df <- as.data.frame(geo_df)
```

#User Interface

```{r}
#Create User Interface
    ui <- bootstrapPage(
    tags$style(type = "text/css", "html, body {width:100%;height:100%}"),
    leafletOutput("map", width = "100%", height = "100%"),
    absolutePanel(top = 10, right = 10,
                  #pickerInput allows for a dropdown with the ability to select multiple values
                   pickerInput(inputId = "input1", 
                              label = "Select Neighborhood:", 
                              choices = sort(unique(geo_df$nbhd_name)), 
                              multiple = TRUE),
                  pickerInput(inputId = "input2", 
                              label = "Select Type of Permit Use:", 
                              choices = sort(unique(geo_df$new_use)), 
                              multiple = TRUE),
                  pickerInput(inputId = "input3", 
                              label = "Select Year:", 
                              choices = sort(unique(geo_df$yr)), 
                              multiple = TRUE),
                  pickerInput(inputId = "input4", 
                              label = "Select Month:", 
                              choices = sort(unique(geo_df$month)), 
                              multiple = TRUE),
                  selectInput("input5", "Permit Cost",
                              choices = sort(unique(geo_df$lrgcost))),
    )
)
```

# Server

```{r}
#Create server
server <- function(input, output, session) {

  # Reactive expression for the data subsetted to what the user selected
    filteredData <- reactive({
        dplyr::filter(geo_df, nbhd_name %in% input$input1 & new_use %in% input$input2 & yr %in% input$input3 & month %in% input$input4 & lrgcost %in% input$input5)
    })
  
    #Base leaflet map, this never changes!
  output$map <- renderLeaflet({
     leaflet() %>% 
      #set mapview to St. Louis City
      setView(lng = -90.1994, lat = 38.6270, zoom = 10.5)%>%
      addProviderTiles(providers$CartoDB.Positron)
   })

  #This code uses leafletProxy() to respond to the user input, calling on filteredData()
  observe({
    leafletProxy("map") %>%
      clearMarkers() %>%
      addMarkers(data = filteredData(), lat = ~cxy_lat, lng = ~cxy_lon, 
                       popup = paste("<b>Neighborhood:</b> ", filteredData()$nbhd_name, "<br>",
                  "<b>Permit Type:</b> ", filteredData()$new_use, "<br>",
                  "<b>Permit Cost:</b> ", filteredData()$EstProjectCost, "<br>")
      )
  })
}

#this runs the shiny app
shinyApp(ui, server)
```

```{r,eval=FALSE}
# this code chunk is for code that potentially will be added

#add slider for months
sliderTextInput(
    inputId = "slider_month",
    label = "Month range slider:",
    choices = month.name
  ),

#add slider for year
  sliderInput("yr_range", "Year", min(fpse$yr), max(fpse$yr),
      value = range(fpse$yr), step = 1),

#reactive expression for year (doesn't work I don't think)
filteredData <- reactive({
    filteredData()[filteredData()$yr >= input$range[1] & filteredData()$yr <= input$range[2],]
  })
```





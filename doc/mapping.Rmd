---
title: "St. Louis Central Corridor West Building Permits"
subtitle: "Monthly Report: January 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: January
  year: 2020
  pastyear: 2019
  date: "2020-01-01"   
  enddate: "2020-02-01"
  
  
  ytd: "2020-01-01" 
  pastdate: "2019-01-01"
  pstmonth: "2019-01-01" 
  pstmonth2: "2019-02-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
#load dependencies
library(dplyr)        # data manipulation
library(readr)        #download csv
library(here)         #file path management
library(kableExtra)   #data tables

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(sf)           # spatial data tools

#other packages
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(knitr)
library(ggplot2)      # plot making
library(formattable)  # currency values
library(lubridate)    # manipulate date time data
library(officer)      # powerpoint manipulation
library(flextable)    # nice tables
```


```{r, include=FALSE}
#load data
setwd('/Users/loganbogenut/Documents/GitHub/stl-building-permits')

df <- read_csv(here::here("data", params$year, params$month, "clean_data.csv"))
#ytd <- read_csv(here::here("data", params$year, params$month,  "ytd.csv"))
#lastyear <- read_csv(here::here("data", params$year, "lastyear.csv")
#lastmonth <- read_csv(here::here("data", params$year, params$month,  "lastmonth.csv")
#lastytd <- read_csv(here::here("data", params$year, params$month,  "lastytd.csv")
avg <- read_csv(here::here("data", params$year, params$month,  "mean_data.csv"))

load(file = here::here("data", "basemap_tiles", "mapbox-tiles.rda"))
load(file = here::here("data", "basemap_tiles", "boundaries.rda"))
load(file = here::here("data", "basemap_tiles", "nbhd-boundaries.rda"))

#create powerpoint
report <- read_pptx()
```

```{r}
#makeshift ytd
df%>%
  mutate(yr = year(as.Date(df$FirstDate,  format="%d/%m/%Y"))) -> df

ytd <- filter(df, FirstDate >= as.Date(params$ytd) & FirstDate <= as.Date(params$enddate))
lastyear <- filter(df, yr == params$pastyear)
lastmonth <- filter(df, FirstDate >= as.Date(params$pstmonth) & FirstDate <= as.Date(params$pstmonth2))
lastytd <- filter(df, FirstDate >= as.Date(params$pastdate) & FirstDate <= as.Date(params$pstmonth2))
```


```{r, include=FALSE}
#import parcel data
st_read(here::here("/data/working-db/parcels", "prcl.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> prcl
```


```{r, include=FALSE}
#make sure both are numeric
df$HANDLE <- as.numeric(df$HANDLE)
prcl$HANDLE <- as.numeric(prcl$HANDLE)

#merge by handle
merge <- df%>%
  merge(prcl, by = "HANDLE")
```

```{r}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "St. Louis Central Corridor West Building Permits", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(c(params$month, params$year), location = ph_location_type(type = "subTitle"))%>%
  ph_with(value = "Washington University Medical Center", location = ph_location_type(type = "dt"))%>%
  
  #introduction slide
  add_slide()%>%
  ph_with(value = "Introduction", location = ph_location_type(type = "title"))%>%
  ph_with(c("Data retreived from https://www.stlouis-mo.gov/data/", "Building permits with a cost of $0 were dropped", "Building permits that were cancelled were dropped"), location = ph_location_type(type = "body")) -> report
```

### All Neighborhoods: Summary

```{r}
# Average cost by neighborhood for each `new_use`

ggplot(avg, aes(x = nbhd_name, y = mean, fill = new_use)) +
  geom_bar(position = "dodge", stat="identity") +
  ggtitle("Average Building Permit Cost By Neighborhood") +
  theme(plot.title = element_text(hjust = 0.5),
    axis.title.y = element_blank()) +
  ylab("Cost") +
  labs(fill = "New Use") +
  scale_y_continuous(labels = scales::dollar_format())+
  coord_flip()

ggsave(here::here("results", params$year, params$month, "allnbhd_plot.png"), width = 7, height = 4, units = "in", dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "allnbhd_plot.png"), width = 7, height = 4),
          location = ph_location_type())%>%
  ph_with("Neighborhood Summary", 
               location = ph_location_type(
                 type = "title") )-> report

```

```{r, echo = FALSE}
    #create in depth summary table
  df%>%
  group_by(nbhd_name)%>%
  summarize(mean = mean(EstProjectCost), count = n())%>%
  select(nbhd_name, mean, count) -> table
  
#make a currency value
table$mean <- currency(table$mean, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(nbhd_name = "Neighborhood", 
    mean = "Average Cost", count = "# of Permits") -> flex01

  #add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Neighborhood Summary", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
```


### Forest Park Southeast: Summary Notes

```{r FPSE ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 39)
nbhd19 <- filter(lastyear, Nbrhd == 39)
tot20 <- filter(ytd, Nbrhd ==39)
tot19 <- filter(lastytd, Nbrhd == 39)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Forest Park Southeast in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Forest Park Southeast in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Forest Park Southeast in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Forest Park Southeast in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Forest Park Southeast: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Forest Park Southeast: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r FPSE Building Permit Mapping, include = FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){

#write shapefile
fpse_shp <- filter(merge, nbhd_name == "Forest Park Southeast")
st_write(fpse_shp, here::here("data", params$year, params$month, "shapefiles", "fpse.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "fpse.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> fpse

#mapping
tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  fpse%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> fpse_map

#save map as .jpeg
tmap_save(fpse_map, file = here::here("results", params$year, params$month, "fpse", "fpse_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fpse", "fpse_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Forest Park Southeast", 
               location = ph_location_type(
                 type = "title") )-> report
  }
```

```{r FPSE summary table, echo=FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){
    
    #create summary table
  df%>%
  filter(nbhd_name == "Forest Park Southeast")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Forest Park Southeast") -> flex01
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Forest Park Southeast", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 39,]) < 15){
    
    #create in depth summary table
  df%>%
  filter(nbhd_name == "Forest Park Southeast")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "address")%>%
    set_caption("Forest Park Southeast Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Forest Park Southeast Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r fpse plot, echo=FALSE, message=FALSE}
if("Forest Park Southeast" %in% df$nbhd_name){
fpse <- filter(df, nbhd_name == "Forest Park Southeast")
ggplot(fpse, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nForest Park Southeast by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> fpse_plot

ggsave(here::here("results",  params$year, params$month, "fpse", "fpse_cost.png"), plot = fpse_plot, dpi = 300)

knitr::include_graphics(here::here("results", params$year, params$month, "fpse", "fpse_cost.png"))

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = fpse_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### Central West End: Summary Notes

```{r CWE ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 38)
nbhd19 <- filter(lastyear, Nbrhd == 38)
tot20 <- filter(ytd, Nbrhd ==38)
tot19 <- filter(lastytd, Nbrhd == 38)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Central West End in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Central West End in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Central West End in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Central West End in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Central West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Central West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report

```


```{r CWE Building Permit Mapping, include = FALSE}

if("Central West End" %in% df$nbhd_name){

#write shapefile  
cwe_shp <- filter(merge, nbhd_name == "Central West End")
st_write(cwe_shp, here::here("data", params$year, params$month, "shapefiles", "cwe.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "cwe.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> cwe

#map shapefile
tm_shape(cwe_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 38) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  cwe%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> cwe_map

#save map as .jpeg
tmap_save(cwe_map, file = here::here("results", params$year, params$month, "cwe", "cwe_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "cwe", "cwe_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Central West End", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("Central West End" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Central West End")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Central West End") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Central West End", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r CWE summary table, echo = FALSE}
if("Central West End" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 38,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Central West End")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "address")%>%
    set_caption("Central West End Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Central West End Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r CWE Permit Use Knit, echo = FALSE, out.width = "20%"}
if("Central West End" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "cwe", "cwe_use.jpeg"))
}
```

```{r CWE plot, echo=FALSE, message=FALSE}
if("Central West End" %in% df$nbhd_name){
cwe <- filter(df, nbhd_name == "Central West End")
ggplot(cwe, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nCentral West End by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> cwe_plot

ggsave(here::here("results",  params$year, params$month, "cwe", "cwe_cost.png"), plot = cwe_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = cwe_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```

### DeBaliviere Place: Summary Notes

```{r dbplace ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 47)
nbhd19 <- filter(lastyear, Nbrhd == 47)
tot20 <- filter(ytd, Nbrhd == 47)
tot19 <- filter(lastytd, Nbrhd == 47)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in DeBaliviere Place in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in DeBaliviere Place in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in DeBaliviere Place in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in DeBaliviere Place in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "DeBaliviere Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "DeBaliviere Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r DeBaliviere Place Building Permit Mapping, include = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){

#write shapefile  
dbplace_shp <- filter(merge, nbhd_name == "DeBaliviere Place")
st_write(dbplace_shp, here::here("data", params$year, params$month, "shapefiles", "dbplace.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "dbplace.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> dbplace

#map shapefile
tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  dbplace%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> dbplace_map

#save map as .jpeg
tmap_save(dbplace_map, file = here::here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("DeBaliviere Place", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
    
 #create summary table
  df%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("DeBaliviere Place") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "DeBaliviere Place", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r dbplace summary table, echo = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 47,]) < 15){
    
  #create in depth summary table
  df%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("DeBaliviere Place Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "DeBaliviere Place Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r dbplace Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("DeBaliviere Place" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"))
}
```

```{r dbplace plot, echo=FALSE, message=FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
dbplace <- filter(df, nbhd_name == "DeBaliviere Place")
ggplot(dbplace, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits\nin DeBaliviere Place by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> dbplace_plot

ggsave(here::here("results",  params$year, params$month, "dbplace", "dbplace_cost.png"), plot = dbplace_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = dbplace_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```

### Skinker DeBaliviere: Summary Notes

```{r skinker ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 46)
nbhd19 <- filter(lastyear, Nbrhd == 46)
tot20 <- filter(ytd, Nbrhd == 46)
tot19 <- filter(lastytd, Nbrhd == 46)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Skinker DeBaliviere in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Skinker DeBaliviere in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Skinker DeBaliviere in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Skinker DeBaliviere in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Skinker DeBaliviere: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Skinker DeBaliviere: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Skinker DeBaliviere Building Permit Mapping, include = FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){

#write shapefile
skinker_shp <- filter(merge, nbhd_name == "Skinker DeBaliviere")
st_write(skinker_shp, here::here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> skinker

#mapping
tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  skinker%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> skinker_map

#save map as .jpeg
tmap_save(skinker_map, file = here::here("results", params$year, params$month, "skinker", "skinker_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "skinker", "skinker_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Skinker DeBaliviere", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Skinker DeBaliviere summary table, echo = FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
#print summary table
  knitr::kable(table,
               col.names = c("New Use", "Average Cost", "Permit Count"),
               format="markdown", caption = "Skinker DeBaliviere")
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Skinker DeBaliviere") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Skinker DeBaliviere", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 46,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)

#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Skinker DeBaliviere Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Skinker DeBaliviere Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r Skinker Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Skinker DeBaliviere" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "skinker", "skinker_use.jpeg"))
}
```

```{r skinker plot, echo=FALSE, message=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
skinker <- filter(df, nbhd_name == "Skinker DeBaliviere")
ggplot(skinker, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nSkinker DeBaliviere by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> skinker_plot

ggsave(here::here("results",  params$year, params$month, "skinker", "skinker_cost.png"), plot = skinker_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = skinker_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### West End: Summary Notes

```{r West End ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 48)
nbhd19 <- filter(lastyear, Nbrhd == 48)
tot20 <- filter(ytd, Nbrhd == 48)
tot19 <- filter(lastytd, Nbrhd == 48)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in West End in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in West End in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in West End in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in West End in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r West End Building Permit Mapping, include = FALSE}

if("West End" %in% df$nbhd_name){

#write shapefile
westend_shp <- filter(merge, nbhd_name == "West End")
st_write(westend_shp, here::here("data", params$year, params$month, "shapefiles", "westend.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "westend.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> westend

#mapping
tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  westend%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> westend_map

#save map as .jpeg
tmap_save(westend_map, file = here::here("results", params$year, params$month, "westend", "westend_use.jpeg"), dpi = 500) 

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "westend", "westend_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("West End", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r West End summary table, echo=FALSE}
if("West End" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "West End")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
#print summary table
  knitr::kable(table,
               col.names = c("New Use", "Average Cost", "Permit Count"),
               format="markdown", caption = "West End")
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("West End") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "West End", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r West End summary table, echo=FALSE}
if("West End" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 48,]) < 15){

    #create in depth summary table
  df%>%
  filter(nbhd_name == "West End")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("West End Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "West End Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r westend plot, echo=FALSE, message=FALSE}
if("West End" %in% df$nbhd_name){
westend <- filter(df, nbhd_name == "West End")
ggplot(westend, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permitsin\nWest End by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> westend_plot

ggsave(here::here("results",  params$year, params$month, "westend", "westend_cost.png"), plot = westend_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = westend_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### Visitation Park: Summary Notes

```{r vstprk ytd summary notes}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 49)
nbhd19 <- filter(lastyear, Nbrhd == 49)
tot20 <- filter(ytd, Nbrhd == 49)
tot19 <- filter(lastytd, Nbrhd == 49)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Visitation Park in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Visitation Park in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Visitation Park in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Visitation Park in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Visitation Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Visitation Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Visitation Park Building Permit Mapping, include = FALSE}
if("Visitation Park" %in% df$nbhd_name){
  
#write shapefile
visit_shp <- filter(merge, nbhd_name == "Visitation Park")
st_write(visit_shp, here::here("data", params$year, params$month, "shapefiles", "vstprk.shp"), 
         delete_dsn = TRUE)
  
#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "vstprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vstprk

#map shapefile
tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vstprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vstprk_map

#save map as .jpeg
tmap_save(vstprk_map, file = here::here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Visitation Park", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo = FALSE}
if("Visitation Park" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Visitation Park")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Visitation Park") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Visitation Park", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Visitation Park" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 49,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Visitation Park")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Visitation Park Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Visitation Park Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r vstprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
#display map
if("Visitation Park" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"))
}
```

```{r vstprk plot, echo=FALSE, message=FALSE}
if("Visit Park" %in% df$nbhd_name){
vstprk <- filter(df, nbhd_name == "Visitation Park")
ggplot(vstprk, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nVisitation Park by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vstprk_plot

ggsave(here::here("results",  params$year, params$month, "vstprk", "vstprk_cost.png"), plot = vstprk_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = vstprk_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### Academy: Summary Notes

```{r Academy ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 51)
nbhd19 <- filter(lastyear, Nbrhd == 51)
tot20 <- filter(ytd, Nbrhd == 51)
tot19 <- filter(lastytd, Nbrhd == 51)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Academy in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Academy in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Academy in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Academy in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Academy: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Academy: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Academy Building Permit Mapping, include = FALSE}
if("Academy" %in% df$nbhd_name){
  
#write shapefile  
  academy_shp <- filter(merge, nbhd_name == "Academy")
  st_write(academy_shp, here::here("data", params$year, params$month, "shapefiles", "academy.shp"), 
         delete_dsn = TRUE)


#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "academy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> academy

#tm mapping
tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  academy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> academy_map

#save map as .jpeg
tmap_save(academy_map, file = here::here("results", params$year, params$month, "academy", "ac_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "academy", "ac_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Academy", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Academy summary table, echo = FALSE}
if("Academy" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Academy")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n())-> table
  
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Academy") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Academy", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r Academy summary table, echo=FALSE}
if("Academy" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 51,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Academy")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Academy Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Academy Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r Academy Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Academy" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "academy", "ac_use.jpeg"))
}
```

```{r Academy plot, echo=FALSE, message=FALSE}
if("Academy" %in% df$nbhd_name){
academy <- filter(df, nbhd_name == "Academy")
ggplot(academy, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Academy by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ac_plot

ggsave(here::here("results",  params$year, params$month, "academy", "ac_cost.png"), plot = ac_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = ac_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### Fountain Park: Summary Notes

```{r ftnprk ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 53)
nbhd19 <- filter(lastyear, Nbrhd == 53)
tot20 <- filter(ytd, Nbrhd == 53)
tot19 <- filter(lastytd, Nbrhd == 53)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Fountain Park in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Fountain Park in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Fountain Park %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Fountain Park in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Fountain Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Fountain Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Fountain Park Building Permit Mapping, include = FALSE}
if("Fountain Park" %in% df$nbhd_name){

#write shapefile
ftnprk_shp <- filter(merge, nbhd_name == "Fountain Park")
st_write(ftnprk_shp, here::here("data", params$year, params$month, "shapefiles", "ftnprk.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "ftnprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> ftnprk

#map shapefile
tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  ftnprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> ftnprk_map

#save map as .jpeg
tmap_save(ftnprk_map, file = here::here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Fountain Park", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r Fountain Park summary table, echo = FALSE}
if("Fountain Park" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Fountain Park")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Fountain Park") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Fountain Park", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Fountain Park" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 53,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Fountain Park")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Fountain Park Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Fountain Park Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```


```{r ftnprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
#display map
if("Fountain Park" %in% df$nbhd_name){
  knitr::include_graphics(here::here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"))
}
```

```{r ftnprk plot, echo=FALSE, message=FALSE}
if("Fountain Park" %in% df$nbhd_name){
ftnprk <- filter(df, nbhd_name == "Fountain Park")
ggplot(ftnprk, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Fountain Park by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ftnprk_plot

ggsave(here::here("results",  params$year, params$month, "ftnprk", "ftnprk_cost.png"), plot = ftnprk_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = ftnprk_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```

### Lewis Place: Summary Notes

```{r Lewis Place ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 54)
nbhd19 <- filter(lastyear, Nbrhd == 54)
tot20 <- filter(ytd, Nbrhd == 54)
tot19 <- filter(lastytd, Nbrhd == 54)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Lewis Place in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Lewis Place in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Lewis Place in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Lewis Place in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Lewis Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Lewis Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Lewis Place Building Permit Mapping, include = FALSE}

if("Lewis Place" %in% df$nbhd_name){

#write shapefile
lewis_shp <- filter(merge, nbhd_name == "Lewis Place")
st_write(lewis_shp, here::here("data", params$year, params$month, "shapefiles", "lewis.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "lewis.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> lewis

#map shapefile
tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  lewis%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> lewis_map

#save map as .jpeg
tmap_save(lewis_map, file = here::here("results", params$year, params$month, "lewis", "lewis_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "lewis", "lewis_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Lewis Place", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r, echo=FALSE}
if("Lewis Place" %in% df$nbhd_name){
    
    #create summary table
  df%>%
  filter(nbhd_name == "Lewis Place")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Lewis Place") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Lewis Place", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Lewis Place" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 54,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Lewis Place")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Lewis Place Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Lewis Place Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r Lewis plot, echo=FALSE, message=FALSE}
if("Lewis Place" %in% df$nbhd_name){
lewis <- filter(df, nbhd_name == "Lewis Place")
ggplot(lewis, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Lewis Place by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> lewis_plot

ggsave(here::here("results",  params$year, params$month, "lewis", "lewis_cost.png"), plot = lewis_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = lewis_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


### Vandeventer

```{r vandy ytd summary}
#filter out neighborhood
nbhd20 <- filter(df, Nbrhd == 58)
nbhd19 <- filter(lastyear, Nbrhd == 58)
tot20 <- filter(ytd, Nbrhd == 58)
tot19 <- filter(lastytd, Nbrhd == 58)

#create cost and year to date variables for each year
bp20 <- nrow(nbhd20)
bp19 <- nrow(nbhd19)
cost20 <- mean(nbhd20$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
cost19 <- mean(nbhd19$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
bptot20 <- nrow(tot20)
bptot19 <- nrow(tot19)
totcost20 <- mean(tot20$EstProjectCost)
totcost20 <- currency(totcost20, digits = 0L)
totcost19 <- mean(tot19$EstProjectCost)
totcost19 <- currency(totcost19, digits = 0L)

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
pct_chg_ytd20 <- (bptot20 - bptot19)/bptot19
pct_chg_ytd20 <- percent(pct_chg_ytd20)
pct_chg_cost20 <- (totcost20 - totcost19)/totcost19
pct_chg_cost20 <- percent(pct_chg_cost20)
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Vandeventer in %s %s",
                    bp20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total building permits)", 
                    pct_chg_cnt, params$month, params$pastyear, bp19)
sprint_3 <- sprintf("%s : Average building permit cost in Vandeventer in %s %s",
                    cost20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s)", 
                    pct_chg_cost, params$month, params$pastyear, cost19)
sprint_5 <- sprintf("%s total building permits in Vandeventer in %s", 
                    bptot20, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total building permits)", 
                    pct_chg_ytd20, params$pastyear, bptot19)
sprint_7 <- sprintf("%s : Average building permit cost in Vandeventer in %s", 
                    totcost20, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s)", 
                    pct_chg_cost20, params$pastyear, totcost19)

#write ytd sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Vandeventer: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Vandeventer: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```


```{r Vandeventer Building Permit Mapping, include = FALSE}
if("Vandeventer" %in% df$nbhd_name){
  
#write shapefile
vandy_shp <- filter(merge, nbhd_name == "Vandeventer")
st_write(vandy_shp, here::here("data", params$year, params$month, "shapefiles", "vandy.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here::here("data", params$year, params$month, "shapefiles", "vandy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vandy

#mapping
tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vandy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vandy_map

#save map as .jpeg
tmap_save(vandy_map, file = here::here("results", params$year, params$month, "vandy", "vandy_use.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vandy", "vandy_use.jpeg")), location = ph_location_fullsize())%>%
  ph_with("Vandeventer", 
               location = ph_location_type(
                 type = "title") )-> report
}
```

```{r vandy summary table, echo=FALSE}
if("Vandeventer" %in% df$nbhd_name){
    
  #create summary table
  df%>%
  filter(nbhd_name == "Vandeventer")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#make avg_cost a currency value
table$avg_cost <- currency(table$avg_cost, digits = 0L)
  
  #print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(new_use = "New Use", 
    avg_cost = "Average Cost", permit_count = "# of Permits")%>%
    set_caption("Vandeventer") -> flex01

#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Vandeventer", location = ph_location_type(type = "title"))%>%
    ph_with(flex01, location = ph_location_type(type = "body")) -> report
}
```

```{r, echo=FALSE}
if("Vandeventer" %in% df$nbhd_name){
  if(nrow(df[df$Nbrhd == 58,]) < 15){
  
  #create in depth summary table
  df%>%
  filter(nbhd_name == "Vandeventer")%>%
    select(OwnerName, new_use, EstProjectCost, OrigAddress) -> table
  
#make a currency value
table$EstProjectCost <- currency(table$EstProjectCost, digits = 0L)
  
#print summary table
  flextable(table)%>%
  autofit()%>%
  set_header_labels(OwnerName = "Owner", new_use = "New Use", 
    EstProjectCost = "Cost", OrigAddress = "Address")%>%
    set_caption("Vandeventer Individual Permit Breakdown") -> flex02
  
#add powerpoint slide
  report%>%
    add_slide()%>%
    ph_with(value = "Vandeventer Individual Permit Breakdown", location = ph_location_type(type = "title"))%>%
    ph_with(flex02, location = ph_location_type(type = "body")) -> report
}}
```

```{r vandy plot, echo=FALSE, message=FALSE}
if("Vandeventer" %in% df$nbhd_name){
vandy <- filter(df, nbhd_name == "Vandeventer")
ggplot(vandy, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nVandeventer by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vandy_plot

ggsave(here::here("results",  params$year, params$month, "vandy", "vandy_cost.png"), plot = vandy_plot, dpi = 300)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(value = vandy_plot,
                 location = ph_location_fullsize(),
                 bg = "transparent") -> report
}
```


```{r}
#save powerpoint
print(report, target = here::here("results", params$year, params$month, "finalreport.pptx"))
```


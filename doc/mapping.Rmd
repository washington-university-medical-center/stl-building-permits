---
title: "St. Louis Building Permits"
subtitle: "Monthly Report: January 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: January
  year: 2020
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
#load dependencies
library(dplyr)        # data manipulation
library(readr)        #download csv
library(here)         #file path management
library(kableExtra)   #data tables

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(sf)           # spatial data tools

#other packages
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(knitr)
library(ggplot2)      # plot making
```


```{r, include=FALSE}
#load data
setwd('/Users/loganbogenut/Documents/GitHub/stl-building-permits')

#read_csv(here("data", params$year, params$month,  "clean_data.csv"))
df <- read_csv("data/jan2020_clean.csv")

#read_csv(here("data", params$year, params$month,  "mean_data.csv"))
avg <- read_csv("data/jan2020_mean.csv")

load(file = here("data", "basemap_tiles", "mapbox-tiles.rda"))
load(file = here("data", "basemap_tiles", "boundaries.rda"))
load(file = here("data", "basemap_tiles", "nbhd-boundaries.rda"))
```


```{r, include=FALSE}
#import parcel data
st_read(here("/data/working-db/parcels", "prcl.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> prcl
```


```{r, include=FALSE}
#make sure both are numeric
df$HANDLE <- as.numeric(df$HANDLE)
prcl$HANDLE <- as.numeric(prcl$HANDLE)

#merge by handle
merge <- df%>%
  merge(prcl, by = "HANDLE")
```

### Neighborhood Summary

```{r, echo=FALSE, out.width= "20%"}
# Average cost by neighborhood for each `new_use`

ggplot(avg, aes(x = nbhd_name, y = mean, fill = new_use)) +
  geom_bar(position = "dodge", stat="identity") +
  ggtitle("Average Building Permit Cost By Neighborhood") +
  theme(plot.title = element_text(hjust = 0.5),
    axis.title.y = element_blank()) +
  ylab("Cost ($)") +
  labs(fill = "New Use") +
  coord_flip()
```

### Academy

```{r, echo=FALSE}
#calculate number of permits
bp_academy <- nrow(df[df$Nbrhd == 51,])

sprint_1 <- sprintf("%s building permits in Academy in %s %s",
                    bp_academy, params$month, params$year)
```

- **`r sprint_1`**

```{r Academy Building Permit Mapping, include = FALSE}
if("Academy" %in% df$nbhd_name){
  
#write shapefile  
  academy_shp <- filter(merge, nbhd_name == "Academy")
  st_write(academy_shp, here("data", params$year, params$month, "shapefiles", "academy.shp"), 
         delete_dsn = TRUE)


#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "academy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> academy

#tm mapping
tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  academy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> academy_map

#save map as .jpeg
tmap_save(academy_map, file = here("results", params$year, params$month, "academy", "ac_use.jpeg"), dpi = 500)
}
```

```{r Academy summary table, echo=FALSE}
if("Academy" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Academy")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
#print summary table
  knitr::kable(table, format="markdown")
}
```

```{r Academy Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Academy" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "academy", "ac_use.jpeg"))
}
```

```{r Academy plot, echo=FALSE, message=FALSE}
if("Academy" %in% df$nbhd_name){
academy <- filter(df, nbhd_name == "Academy")
ggplot(academy, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Academy by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ac_plot

ggsave(here("results",  params$year, params$month, "academy", "ac_cost.png"), plot = ac_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "academy", "ac_cost.png"))
}
```


### Central West End

```{r, include=FALSE}
bp_cwe <- nrow(df[df$Nbrhd == 38,])

sprint_2 <- sprintf("%s building permits in Central West End in %s %s",
                    bp_cwe, params$month, params$year)
```

- **`r sprint_2`**

```{r CWE Building Permit Mapping, include = FALSE}

if("Central West End" %in% df$nbhd_name){

#write shapefile  
cwe_shp <- filter(merge, nbhd_name == "Central West End")
st_write(cwe_shp, here("data", params$year, params$month, "shapefiles", "cwe.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "cwe.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> cwe

#map shapefile
tm_shape(cwe_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 38) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  cwe%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> cwe_map

#save map as .jpeg
tmap_save(cwe_map, file = here("results", params$year, params$month, "cwe", "cwe_use.jpeg"), dpi = 500)
}else{
  print("No building permits for Central West End neighborhood")
}
```

```{r CWE summary table, echo = FALSE}
if("Central West End" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Central West End")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r CWE Permit Use Knit, echo = FALSE, out.width = "20%"}
if("Central West End" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "cwe", "cwe_use.jpeg"))
}
```

```{r CWE plot, echo=FALSE, message=FALSE}
if("Central West End" %in% df$nbhd_name){
cwe <- filter(df, nbhd_name == "Central West End")
ggplot(cwe, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nCentral West End by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> cwe_plot

ggsave(here("results",  params$year, params$month, "cwe", "cwe_cost.png"), plot = cwe_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "cwe", "cwe_cost.png"))
}
```

### DeBaliviere Place

```{r, include=FALSE}
bp_dbplace <- nrow(df[df$Nbrhd == 47,])

sprint_3 <- sprintf("%s building permits in DeBaliviere Place in %s %s",
                    bp_dbplace, params$month, params$year)
```

- **`r sprint_3`**

```{r DeBaliviere Place Building Permit Mapping, include = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){

#write shapefile  
dbplace_shp <- filter(merge, nbhd_name == "DeBaliviere Place")
st_write(dbplace_shp, here("data", params$year, params$month, "shapefiles", "dbplace.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "dbplace.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> dbplace

#map shapefile
tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  dbplace%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> dbplace_map

#save map as .jpeg
tmap_save(dbplace_map, file = here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"), dpi = 500)
}
```

```{r dbplace summary table, echo = FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
  
 #create summary table
  df%>%
  filter(nbhd_name == "DeBaliviere Place")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r dbplace Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("DeBaliviere Place" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"))
}
```

```{r dbplace plot, echo=FALSE, message=FALSE}
if("DeBaliviere Place" %in% df$nbhd_name){
dbplace <- filter(df, nbhd_name == "DeBaliviere Place")
ggplot(academy, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits\nin DeBaliviere Place by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> dbplace_plot

ggsave(here("results",  params$year, params$month, "dbplace", "dbplace_cost.png"), plot = dbplace_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "dbplace", "dbplace_cost.png"))
}
```

### Forest Park South East

```{r, include=FALSE}
bp_fpse <- nrow(df[df$Nbrhd == 39,])

sprint_4 <- sprintf("%s building permits in Forest Park South East %s %s",
                    bp_fpse, params$month, params$year)
```

- **`r sprint_4`**

```{r FPSE Building Permit Mapping, include = FALSE}

if("Forest Park South East" %in% df$nbhd_name){

#write shapefile
fpse_shp <- filter(merge, nbhd_name == "Forest Park South East")
st_write(fpse_shp, here("data", params$year, params$month, "shapefiles", "fpse.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "fpse.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> fpse

#mapping
tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  fpse%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> fpse_map

#save map as .jpeg
tmap_save(fpse_map, file = here("results", params$year, params$month, "fpse", "fpse_use.jpeg"), dpi = 500)
}else{
  print("No building permits for Forest Park South East neighborhood")
}
```

```{r, echo=FALSE}
if("Forest Park South East" %in% df$nbhd_name){
  
    #create summary table
  df%>%
  filter(nbhd_name == "Forest Park South East")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r FPSE Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Forest Park South East" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "fpse", "fpse_use.jpeg"))
}
```

```{r fpse plot, echo=FALSE, message=FALSE}
if("Forest Park South East" %in% df$nbhd_name){
dbplace <- filter(df, nbhd_name == "Forest Park South East")
ggplot(dbplace, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nForest Park South East by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> fpse_plot

ggsave(here("results",  params$year, params$month, "fpse", "fpse_cost.png"), plot = fpse_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "fpse", "fpse_cost.png"))
}
```

### Fountain Park

```{r, include=FALSE}
bp_ftnprk <- nrow(df[df$Nbrhd == 53,])

sprint_5 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_ftnprk, params$month, params$year)
```

- **`r sprint_5`**

```{r Fountain Park Building Permit Mapping, include = FALSE}
if("Fountain Park" %in% df$nbhd_name){

#write shapefile
ftnprk_shp <- filter(merge, nbhd_name == "Fountain Park")
st_write(ftnprk_shp, here("data", params$year, params$month, "shapefiles", "ftnprk.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "ftnprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> ftnprk

#map shapefile
tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  ftnprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> ftnprk_map

#save map as .jpeg
tmap_save(ftnprk_map, file = here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"), dpi = 500)
}
```

```{r, echo=FALSE}
if("Fountain Park" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Fountain Park")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r ftnprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
#display map
if("Forest Park South East" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"))
}
```

```{r ftnprk plot, echo=FALSE, message=FALSE}
if("Fountain Park" %in% df$nbhd_name){
ftnprk <- filter(df, nbhd_name == "Fountain Park")
ggplot(ftnprk, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Fountain Park by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> ftnprk_plot

ggsave(here("results",  params$year, params$month, "ftnprk", "ftnprk_cost.png"), plot = ftnprk_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "fpse", "fpse_cost.png"))
}
```

### Lewis Place

```{r, include=FALSE}
bp_lewis <- nrow(df[df$Nbrhd == 54,])

sprint_6 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_lewis, params$month, params$year)
```

- **`r sprint_6`**

```{r Lewis Place Building Permit Mapping, include = FALSE}

if("Lewis Place" %in% df$nbhd_name){

#write shapefile
lewis_shp <- filter(merge, nbhd_name == "Lewis Place")
st_write(lewis_shp, here("data", params$year, params$month, "shapefiles", "lewis.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "lewis.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> lewis

#map shapefile
tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  lewis%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> lewis_map

#save map as .jpeg
tmap_save(lewis_map, file = here("results", params$year, params$month, "lewis", "lewis_use.jpeg"), dpi = 500)
}
```

```{r, echo=FALSE}
if("Lewis Place" %in% df$nbhd_name){
  
    #create summary table
  df%>%
  filter(nbhd_name == "Lewis Place")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r Lewis Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Lewis Place" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "lewis", "lewis_use.jpeg"))
}
```

```{r Lewis plot, echo=FALSE, message=FALSE}
if("Lewis Place" %in% df$nbhd_name){
lewis <- filter(df, nbhd_name == "Lewis Place")
ggplot(lewis, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in Lewis by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> lewis_plot

ggsave(here("results",  params$year, params$month, "lewis", "lewis_cost.png"), plot = lewis_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "lewis", "lewis_cost.png"))
}
```

### Skinker DeBaliviere

```{r, include=FALSE}
bp_skinker <- nrow(df[df$Nbrhd == 46,])

sprint_7 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_skinker, params$month, params$year)
```

- **`r sprint_7`**

```{r Skinker DeBaliviere Building Permit Mapping, include = FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){

#write shapefile
skinker_shp <- filter(merge, nbhd_name == "Skinker DeBaliviere")
st_write(skinker_shp, here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> skinker

#mapping
tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  skinker%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> skinker_map

#save map as .jpeg
tmap_save(skinker_map, file = here("results", params$year, params$month, "skinker", "skinker_use.jpeg"), dpi = 500)
}
```

```{r, echo=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Skinker DeBaliviere")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r Skinker Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Skinker DeBaliviere" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "skinker", "skinker_use.jpeg"))
}
```

```{r skinker plot, echo=FALSE, message=FALSE}
if("Skinker DeBaliviere" %in% df$nbhd_name){
skinker <- filter(df, nbhd_name == "Skinker DeBaliviere")
ggplot(skinker, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nSkinker DeBaliviere by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> skinker_plot

ggsave(here("results",  params$year, params$month, "skinker", "skinker_cost.png"), plot = skinker_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "skinker", "skinker_cost.png"))
}
```

### Vandeventer

```{r, include=FALSE}
bp_vandy <- nrow(df[df$Nbrhd == 58,])

sprint_8 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_vandy, params$month, params$year)
```

- **`r sprint_8`**

```{r Vandeventer Building Permit Mapping, include = FALSE}
if("Vandeventer" %in% df$nbhd_name){
  
#write shapefile
vandy_shp <- filter(merge, nbhd_name == "Vandeventer")
st_write(vandy_shp, here("data", params$year, params$month, "shapefiles", "vandy.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "vandy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vandy

#mapping
tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vandy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vandy_map

#save map as .jpeg
tmap_save(vandy_map, file = here("results", params$year, params$month, "vandy", "vandy_use.jpeg"), dpi = 500)
}
```

```{r, echo=FALSE}
if("Vandeventer" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Vandeventer")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r Vandeventer Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("Vandeventer" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "vandy", "vandy_use.jpeg"))
}
```

```{r vandy plot, echo=FALSE, message=FALSE}
if("Vandeventer" %in% df$nbhd_name){
vandy <- filter(df, nbhd_name == "Vandeventer")
ggplot(vandy, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nVandeventer by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vandy_plot

ggsave(here("results",  params$year, params$month, "vandy", "vandy_cost.png"), plot = vandy_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "vandy", "vandy_cost.png"))
}
```

### Visitation Park

```{r, include=FALSE}
bp_ftnprk <- nrow(df[df$Nbrhd == 53,])

sprint_9 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_ftnprk, params$month, params$year)
```

- **`r sprint_9`**

```{r Visitation Park Building Permit Mapping, include = FALSE}
if("Visitation Park" %in% df$nbhd_name){
  
#write shapefile
visit_shp <- filter(merge, nbhd_name == "Visitation Park")
st_write(visit_shp, here("data", params$year, params$month, "shapefiles", "vstprk.shp"), 
         delete_dsn = TRUE)
  
#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "vstprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vstprk

#map shapefile
tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vstprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vstprk_map

#save map as .jpeg
tmap_save(fpse_map, file = here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"), dpi = 500)
}
```

```{r, echo=FALSE}
if("Visitation Park" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "Visitation Park")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r vstprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
#display map
if("Visitation Park" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"))
}
```

```{r vstprk plot, echo=FALSE, message=FALSE}
if("Visit Park" %in% df$nbhd_name){
vstprk <- filter(df, nbhd_name == "Visit Park")
ggplot(vstprk, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permits in\nVisit Park by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> vstprk_plot

ggsave(here("results",  params$year, params$month, "vstprk", "vstprk_cost.png"), plot = vstprk_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "vstprk", "vstprk_cost.png"))
}
```

### West End

```{r, include=FALSE}
bp_westend <- nrow(df[df$Nbrhd == 48,])

sprint_10 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_westend, params$month, params$year)
```

- **`r sprint_10`**

```{r West End Building Permit Mapping, include = FALSE}

if("West End" %in% df$nbhd_name){

#write shapefile
westend_shp <- filter(merge, nbhd_name == "West End")
st_write(westend_shp, here("data", params$year, params$month, "shapefiles", "westend.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "westend.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> westend

#mapping
tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  westend%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> westend_map

#save map as .jpeg
tmap_save(westend_map, file = here("results", params$year, params$month, "westend", "westend_use.jpeg"), dpi = 500) 
}
```

```{r, echo=FALSE}
if("West End" %in% df$nbhd_name){
  
  #create summary table
  df%>%
  filter(nbhd_name == "West End")%>%
  group_by(new_use)%>%
  summarize(avg_cost = mean(EstProjectCost),
            permit_count = n()) -> table
  
  #print summary table
  knitr::kable(table, format="markdown")
}
```

```{r West End Permit Use Knit, echo = FALSE, out.width = "20%"}
#display map
if("West End" %in% df$nbhd_name){
  knitr::include_graphics(here("results", params$year, params$month, "westend", "westend_use.jpeg"))
}
```

```{r westend plot, echo=FALSE, message=FALSE}
if("West End" %in% df$nbhd_name){
westend <- filter(df, nbhd_name == "West End")
ggplot(westend, aes(lrgcost)) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  ggtitle("High Cost Building Permitsin\nWest End by Use") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  scale_x_discrete(labels=c("< $50,000", "> $50,000 "))+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> westend_plot

ggsave(here("results",  params$year, params$month, "westend", "westend_cost.png"), plot = westend_plot, dpi = 300)

knitr::include_graphics(here("results", params$year, params$month, "westend", "westend_cost.png"))
}
```


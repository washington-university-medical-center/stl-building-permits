---
title: "Building Permit Mapping"
subtitle: "Monthly Report: January 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: January
  pastyear: 2019
  year: 2020
  date: "2020-01-01"
  pastdate: "2019-01-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
#load dependencies
library(dplyr)        # data manipulation
library(readr)        #download csv
library(here)         #file path management
library(kableExtra)   #data tables

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(sf)           # spatial data tools

#other packages
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(knitr)
```


```{r, include=FALSE}
#load data
setwd('/Users/loganbogenut/Documents/GitHub/stl-building-permits')

#read_csv(here("data", params$year, params$month,  "clean_data.csv"))
df <- read_csv("data/jan2020_clean.csv")

#read_csv(here("data", params$year, params$month,  "clean_data.csv"))
avg <- read_csv("data/jan2020_mean.csv")

load(file = here("data", "basemap_tiles", "mapbox-tiles.rda"))
load(file = here("data", "basemap_tiles", "boundaries.rda"))
load(file = here("data", "basemap_tiles", "nbhd-boundaries.rda"))
```


```{r, include=FALSE}
#import parcel data
st_read(here("/data/working-db/parcels", "prcl.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> prcl
```


```{r, include=FALSE}
#make sure both are numeric
df$HANDLE <- as.numeric(df$HANDLE)
prcl$HANDLE <- as.numeric(prcl$HANDLE)

#merge by handle
merge <- df%>%
  merge(prcl, by = "HANDLE")
```


### Academy

```{r, include=FALSE}
bp_academy <- nrow(df[df$Nbrhd == 51,])

sprint_1 <- sprintf("%s building permits in Academy in %s %s",
                    bp_academy, params$month, params$year)

cost <- filter(df, nbhd_name == "Academy")

cost%>%
kable()%>%
  by(cost$EstProjectCost, list(cost$new_use), mean)%>%
  kable_styling(full_width = FALSE)
```

- **`r sprint_1`**


```{r Academy Building Permit Mapping, include = FALSE}
academy_shp <- filter(merge, nbhd_name == "Academy")

if(nrow(academy_shp) == 0){
  print("No building permits for this neighborhood")
}else{
  
#write shapefile  
  st_write(academy_shp, here("data", params$year, params$month, "shapefiles", "academy.shp"), 
         delete_dsn = TRUE)


#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "academy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> academy

#tm mapping
tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  academy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> academy_map

#save map as .jpeg
tmap_save(academy_map, file = here("results", params$year, params$month, "academy", "ac_use.jpeg"), dpi = 500)
}
```

### Academy: Building Permit Type

```{r Academy Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(academy_shp) == 0){
  print("No building permits for this neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "academy", "ac_use.jpeg"))
}
```


### Central West End

```{r, include=FALSE}
bp_cwe <- nrow(df[df$Nbrhd == 38,])

sprint_2 <- sprintf("%s building permits in Central West End in %s %s",
                    bp_cwe, params$month, params$year)
```

- **`r sprint_2`**

```{r CWE Building Permit Mapping, include = FALSE}
cwe_shp <- filter(merge, nbhd_name == "Central West End")
if(nrow(cwe_shp) == 0){
  print("No building permits for Central West End neighborhood")
}else{

#write shapefile  
st_write(cwe_shp, here("data", params$year, params$month, "shapefiles", "cwe.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "cwe.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> cwe

#map shapefile
tm_shape(cwe_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 38) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  cwe%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> cwe_map

#save map as .jpeg
tmap_save(cwe_map, file = here("results", params$year, params$month, "cwe", "cwe_use.jpeg"), dpi = 500)
}
```

### Central West End: Building Permit Type

```{r CWE Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(cwe_shp) == 0){
  print("No building permits for Central West End neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "cwe", "cwe_use.jpeg"))
}
```

### DeBaliviere Place

```{r, include=FALSE}
bp_dbplace <- nrow(df[df$Nbrhd == 47,])

sprint_3 <- sprintf("%s building permits in DeBaliviere Place in %s %s",
                    bp_dbplace, params$month, params$year)
```

- **`r sprint_3`**

```{r DeBaliviere Place Building Permit Mapping, include = FALSE}
dbplace_shp <- filter(merge, nbhd_name == "DeBaliviere Place")
if(nrow(dbplace_shp) == 0){
  print("No building permits for DeBaliviere Place neighborhood")
}else{
  
#write shapefile  
st_write(dbplace_shp, here("data", params$year, params$month, "shapefiles", "dbplace.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "dbplace.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> dbplace

#map shapefile
tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  dbplace%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> dbplace_map

#save map as .jpeg
tmap_save(dbplace_map, file = here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"), dpi = 500)
}
```

### DeBaliviere Place: Building Permit Type

```{r dbplace Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(dbplace_shp) == 0){
  print("No building permits for DeBaliviere Place neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "dbplace", "dbplace_use.jpeg"))
}
```

### Forest Park South East

```{r, include=FALSE}
bp_fpse <- nrow(df[df$Nbrhd == 39,])

sprint_4 <- sprintf("%s building permits in Forest Park South East %s %s",
                    bp_fpse, params$month, params$year)
```

- **`r sprint_4`**

```{r FPSE Building Permit Mapping, include = FALSE}
fpse_shp <- filter(merge, nbhd_name == "Forest Park South East")
if(nrow(fpse_shp) == 0){
  print("No building permits for Forest Park South East neighborhood")
}else{

#write shapefile
st_write(fpse_shp, here("data", params$year, params$month, "shapefiles", "fpse.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "fpse.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> fpse

#mapping
tm_shape(fpse_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  fpse%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> fpse_map

#save map as .jpeg
tmap_save(fpse_map, file = here("results", params$year, params$month, "fpse", "fpse_use.jpeg"), dpi = 500)
}
```

### Forest Park South East: Building Permit Type

```{r FPSE Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(fpse_shp) == 0){
  print("No building permits for Forest Park South East neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "fpse", "fpse_use.jpeg"))
}
```

### Fountain Park

```{r, include=FALSE}
bp_ftnprk <- nrow(df[df$Nbrhd == 53,])

sprint_5 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_ftnprk, params$month, params$year)
```

- **`r sprint_5`**

```{r Fountain Park Building Permit Mapping, include = FALSE, eval=FALSE}
ftnprk_shp <- filter(merge, nbhd_name == "Fountain Park")
if(nrow(ftnprk_shp) == 0){
  print("No building permits for Fountain Park neighborhood")
}else{
  
#write shapefile
st_write(ftnprk_shp, here("data", params$year, params$month, "shapefiles", "ftnprk.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "ftnprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> ftnprk

#map shapefile
tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  ftnprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> ftnprk_map

#save map as .jpeg
tmap_save(ftnprk_map, file = here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"), dpi = 500)
}
```

### Fountain Park: Building Permit Type

```{r ftnprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
if(nrow(ftnprk_shp) == 0){
  print("No building permits for Fountain Park neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "ftnprk", "ftnprk_use.jpeg"))
}
```

### Lewis Place

```{r, include=FALSE}
bp_lewis <- nrow(df[df$Nbrhd == 54,])

sprint_6 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_lewis, params$month, params$year)
```

- **`r sprint_6`**

```{r Lewis Place Building Permit Mapping, include = FALSE}
lewis_shp <- filter(merge, nbhd_name == "Lewis Place")
if(nrow(lewis_shp) == 0){
  print("No building permits for Lewis Place neighborhood")
}else{
  
#write shapefile
st_write(lewis_shp, here("data", params$year, params$month, "shapefiles", "lewis.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "lewis.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> lewis

#map shapefile
tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  lewis%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> lewis_map

#save map as .jpeg
tmap_save(lewis_map, file = here("results", params$year, params$month, "lewis", "lewis_use.jpeg"), dpi = 500)
}
```

### Lewis Place: Building Permit Type

```{r Lewis Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(lewis_shp) == 0){
  print("No building permits for Lewis Place neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "lewis", "lewis_use.jpeg"))
}
```

### Skinker DeBaliviere

```{r, include=FALSE}
bp_skinker <- nrow(df[df$Nbrhd == 46,])

sprint_7 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_skinker, params$month, params$year)
```

- **`r sprint_7`**

```{r Skinker DeBaliviere Building Permit Mapping, include = FALSE}
skinker_shp <- filter(merge, nbhd_name == "Skinker DeBaliviere")
if(nrow(skinker_shp) == 0){
  print("No building permits for Skinker DeBaliviere neighborhood")
}else{
  
#write shapefile
st_write(skinker_shp, here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "skinkerdb.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> skinker

#mapping
tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  skinker%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> skinker_map

#save map as .jpeg
tmap_save(skinker_map, file = here("results", params$year, params$month, "skinker", "skinker_use.jpeg"), dpi = 500)
}
```

### Skinker DeBaliviere: Building Permit Type

```{r Skinker Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(skinker_shp) == 0){
  print("No building permits for Skinker DeBaliviere neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "skinker", "skinker_use.jpeg"))
}
```

### Vandeventer

```{r, include=FALSE}
bp_vandy <- nrow(df[df$Nbrhd == 58,])

sprint_8 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_vandy, params$month, params$year)
```

- **`r sprint_8`**

```{r Vandeventer Building Permit Mapping, include = FALSE}
vandy_shp <- filter(merge, nbhd_name == "Vandeventer")
if(nrow(vandy_shp) == 0){
  print("No building permits for Vandeventer neighborhood")
}else{
  
#write shapefile
st_write(vandy_shp, here("data", params$year, params$month, "shapefiles", "vandy.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "vandy.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vandy

#mapping
tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vandy%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vandy_map

#save map as .jpeg
tmap_save(vandy_map, file = here("results", params$year, params$month, "vandy", "vandy_use.jpeg"), dpi = 500)
}
```

### Vandeventer: Building Permit Type

```{r Vandeventer Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(vandy_shp) == 0){
  print("No building permits for Vandeventer neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "vandy", "vandy_use.jpeg"))
}
```

### Visitation Park

```{r, include=FALSE}
bp_ftnprk <- nrow(df[df$Nbrhd == 53,])

sprint_9 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_ftnprk, params$month, params$year)
```

- **`r sprint_9`**

```{r Visitation Park Building Permit Mapping, include = FALSE, eval=FALSE}
visit_shp <- filter(merge, nbhd_name == "Visitation Park")
if(nrow(visit_shp) == 0){
  print("No building permits for Visitation Park neighborhood")
}else{
  
#write shapefile
st_write(visit_shp, here("data", params$year, params$month, "shapefiles", "vstprk.shp"), 
         delete_dsn = TRUE)
  
#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "vstprk.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> vstprk

#map shapefile
tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  vstprk%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vstprk_map

#save map as .jpeg
tmap_save(fpse_map, file = here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"), dpi = 500)
}
```

### Visitation Park: Building Permit Type

```{r vstprk Permit Use Knit, echo = FALSE, out.width = "20%", eval=FALSE}
if(nrow(visit_shp) == 0){
  print("No building permits for Visitation Park neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "vstprk", "vstprk_use.jpeg"))
}
```

### West End

```{r, include=FALSE}
bp_westend <- nrow(df[df$Nbrhd == 48,])

sprint_10 <- sprintf("%s building permits in Fountain Park %s %s",
                    bp_westend, params$month, params$year)
```

- **`r sprint_10`**

```{r West End Building Permit Mapping, include = FALSE}
westend_shp <- filter(merge, nbhd_name == "West End")
if(nrow(westend_shp) == 0){
  print("No building permits for West End neighborhood")
}else{
  
#write shapefile
st_write(westend_shp, here("data", params$year, params$month, "shapefiles", "westend.shp"), 
         delete_dsn = TRUE)

#Load shapefile
st_read(here("data", params$year, params$month, "shapefiles", "westend.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> westend

#mapping
tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  westend%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = "Set1",
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> westend_map

#save map as .jpeg
tmap_save(westend_map, file = here("results", params$year, params$month, "westend", "westend_use.jpeg"), dpi = 500) 
}
```

### West End: Building Permit Type

```{r West End Permit Use Knit, echo = FALSE, out.width = "20%"}
if(nrow(westend_shp) == 0){
  print("No building permits for West End neighborhood")
}else{
knitr::include_graphics(here("results", params$year, params$month, "westend", "westend_use.jpeg"))
}
```




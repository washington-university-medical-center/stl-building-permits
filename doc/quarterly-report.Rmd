---
title: "Quarterly Report"
author: "Logan Williams"
date: "11/9/2020"
output: html_document
params:
  quarter: 3
  year: 2020
  pastyear: 2019
---

```{r}
#load dependencies
library(ggplot2)      # plot making
library(flextable)    # pretty tables
library(here)         # file path management
library(dplyr)        # data cleaning
library(officer)      # powerpoint output
library(formattable)  # currency values
#library(ggrepel)      # ggplot labels
library(readr)        # load csv
library(rlang)        # check for empty values
library(janitor)      # create column totals

#spatial packages
library(sf)           # spatial data tools
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
```

```{r}
#load data
df <- read_csv(here::here("data", params$year, "quarterly", params$quarter, "quarter-data.csv"))
lstqrt <- read_csv(here::here("data", params$year, "quarterly", params$quarter, "past-qrtr-data.csv"))


# load basemap tiles
load(file = here::here("data", "basemap_tiles", "mapbox-tiles.rda"))
load(file = here::here("data", "basemap_tiles", "boundaries.rda"))
load(file = here::here("data", "basemap_tiles", "nbhd-boundaries.rda"))

# create dataframe of means
df %>%
  group_by(nbhd_name, new_use) %>%
  summarise(sum = sum(EstProjectCost)/10000)%>%
  mutate(pos = (cumsum(sum)-0.5*sum))-> means

#import parcel data
st_read(here::here("data", "working-db", "parcels", "prcl.shp"),
        stringsAsFactors = FALSE) %>%
  st_transform(crs = 32615) -> prcl

#merge by handle
merge <- df%>%
  merge(prcl, by = "HANDLE")

use <- c("Industrial", "Institutional", "Residential", "Commercial")
# summary note colors
reg24 <- fp_text(color = 'black', font.size = 24)
reg20 <- fp_text(color = 'black', font.size = 20)
boldline <- fp_text(color = "black", font.size = 28, bold = TRUE, underlined = TRUE)
bold <- fp_text(color = "black", font.size = 24, bold = TRUE)
#create custom color palette for plots
col <- c("Industrial" = "#e41a1c", "Residential" = "#377eb8", "Commercial" = "#4daf4a", "Institutional" = "#984ea3")

# create powerpoint
report <- read_pptx()
```

#Function References

`fp_text` creates a font style for an officer powerpoint slide.

`ftext` creates a formatted chunk of text, often referencing `fp_text` for formatting instructions.

`fpar` creates formatted paragraphs in Powerpoint. Used to concatenate `ftext` objects into a paragraph.

`block_list` combines several blocks, or `fpar` objects, into a single object. Used to create formatted paragraphs in Powerpoint.

`read_pptx` creates a powerpoint presentation. You can use a variety of functions to add content to the presentation once the object is created.

`add_slide` adds a powerpoint slide to an existing powerpoint object. Specify what kind of layout you want the slide to be.

`ph_with` adds content to an existing powerpoint slide. This function often follows the `add_slide` function. This function is used to add everything from tables, to titles to body paragraphs on your powerpoint slide.

`sprintf` creates a character vector containing a formatted combination of text and variable values. In this notebook it is used for summary notes where it references the paramaters as well as certain variable values.

`filter` is a dplyr function that is used to clean data. Specifically it is used to find rows/cases where a condition is true. If the condition is true then the values are kept, if not they are dropped.

`group_by` takes an existing tbl and converts it into a grouped tbl based on a specific variable.

`rename` does exactly what you think it does. It renames variables based on name.

`replace` replaces a certain value with another. It is used in this notebook to replace NAs with 0.

`add_row` adds a row to a dataframe. It is used to add rows to tables based on whether or not a specific crime was committed. So, if there were no arsons that month, the `add_row` function is used to add this crime with values of 0.

`arrange` sorts a variable in ascending order

`adorn_totals` adds a "totals" row or column to a data frame.

`colformat_num` formats numeric variables in a flextable. Specifically aimed at controlling the number of digits displayed.

`add_header_lines` adds a header to a flextable.

`autofit` is used to automatically adjust flextable height and width to fit the size of desired content.

`is_empty` checks if an object has a value or not. If the value is missing, then we use `add_row` to add the missing permit type.

`tm_shape` creates a tmap-element that draws polygons.

`tm_fill` fills map shapes based on what you want. You can either choose a fixed color or map create a color palette mapped to a variable.

`tm_borders` adds borders to a map shape

`tm_credits` adds map credits.

`tm_bubbles` creates bubbles. This is how we represent crime points on a map.

`tm_layout` specifies map layout. Used for controlling/creating map legend

`tmap_save` saves a tmap object.

`ggsave` saves a ggplot object.

`convert_to_pdf` uses libreOffice (another application) to convert the saved powerpoint into a PDF.

`ggplot` initializes a ggplot object. Can be used to specify the data frame and the plot aesthetics.

`geom_bar` creates a bar plot in a ggplot object

`geom_text` is used to place text in a ggplot object. It is used in this notebook to label the stacked bar chart values that are greater than a certain amount.

`coord_flip` flips the x and the y axis in ggplot.

`scale_colour_manual` used to assign specific color values to ggplot. This references the `cols` vector to make sure that symbology is consistent throughout the report.

`xlab` `ylab` creates axis labels in a ggplot object.

`unique` returns all unique values in a given vector. It is used in the `for` loop of this notebook to extract the neighborhood name in each iteration of the loop.

`comment` adds a comment to any R object. It is used in this notebook to add the neighborhood name to the basemap tiles. This helps the `for` loop run more efficiently.

`min` returns the minimum value in a vector.

`max` returns the maximum value in a vector.

`median` returns the median value of a vector.

`mean` returns the mean average of a vector.

`sum` returns the total sum of a vector

`currency` formats values as currency.

`is.infinite` checks if a value is infinite or not. It is used in the summary notes to identify whether a perentage change is infinite or not, i.e. dividing a number by 0.

`is.nan` is used to check if a value is NA or not. It is used in the summary notes to identify NA values, which are instances where mathematic operations cannot apply, i.e. when there are no building permits and ergo no values to perform such operations.

`percent` formats values as a percentage

`as.numeric` formats values as numberic.

`summarise` or `summarize` are used in conjunction with `group_by` to create an output that has one row for each group specified in the `summarise` function.

`set_header_lables` allows you to change column names in a flextable.

`width` is used on flextables to adjust flextable width.

`st_as_sf` converts an object into a simple feature object.

`st_transform` transforms or converts the coordinates of a simple feature object.

```{r}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "St. Louis Central Corridor West Building Permits", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(paste("Quarter", params$quarter, "Report:", params$year), location = ph_location_type(type = "subTitle"))%>%
  ph_with(value = "Washington University Medical Center", location = ph_location_type(type = "dt")) -> report

#add STL map reference
report%>%
add_slide()%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", "spat_ref.png"), height = 5, width = 9),
          ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("St. Louis Neighborhood Spatial Reference", 
               location = ph_location_type(
                 type = "title") )-> report

# Average cost by neighborhood for each `new_use`
# ggplot(means, aes(x = nbhd_name, y = mean, fill = new_use)) +
#   scale_colour_manual(
#     values = col,
#     aesthetics = c("colour", "fill")
#   ) +
#   geom_bar(position = "dodge", stat="identity") +
#   theme(plot.title = element_text(hjust = 0.5),
#     axis.title.y = element_blank()) +
#   ylab("Cost") +
#   labs(fill = "New Use") +
#   scale_y_continuous(labels = scales::dollar_format())+
#   coord_flip()

ggplot(means, aes(x = nbhd_name, y = sum, fill = new_use, label = sum)) +
  scale_colour_manual(
    values = col,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=ifelse(sum>1000,paste0("$", round(sum,0)),"")), position = position_stack(vjust = 0.5), colour="white") +
  scale_y_continuous(labels=scales::dollar_format(prefix="$")) +
  coord_flip()+
  labs(y="Thousands of $", x="")+
  scale_fill_discrete(name = "Permit Type")

ggsave(here::here("results", params$year, "quarterly", params$quarter, "all_nbhds", "allnbhd_plot.png"), 
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "quarterly", params$quarter, "all_nbhds", "allnbhd_plot.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Neighborhood Summary: Total Building Permit Cost", 
               location = ph_location_type(
                 type = "title") )-> report

#create comments to use to filter and name outputs
comment(cwe_tiles) <- "Central West End"
comment(fpse_tiles) <- "Forest Park Southeast"
comment(sdb_tiles) <- "Skinker DeBaliviere"
comment(dbp_tiles) <- "DeBaliviere Place"
comment(we_tiles) <- "West End"
comment(vp_tiles) <- "Visitation Park"
comment(ac_tiles) <- "Academy"
comment(fp_tiles) <- "Fountain Park"
comment(lp_tiles) <- "Lewis Place"
comment(vd_tiles) <- "Vandeventer"

for ( i in list(cwe_tiles, fpse_tiles, sdb_tiles, dbp_tiles, we_tiles, vp_tiles, ac_tiles, fp_tiles, lp_tiles, vd_tiles) ) { 
  #assign comments to an object
  name <- comment(i)
  #only run code for neighborhoods with developments
  if(name %in% merge$nbhd_name){
  sub <- filter(merge, nbhd_name == name)
  abbr <- unique(sub$abbr)
  num <- unique(sub$Nbrhd)

#create mean, median, range stats
mean <- mean(sub$EstProjectCost)
mean <- currency(mean, digits = 0L)
if(is.nan(mean)){mean[is.nan(mean)] <- 0}
if(is.infinite(mean)){mean[is.infinite(mean)] <- 0}
median <- median(sub$EstProjectCost)
median <- currency(median, digits = 0L)
if(is.nan(median)){median[is.nan(median)] <- 0}
if(is.infinite(median)){median[is.infinite(median)] <- 0}
min <- min(sub$EstProjectCost)
min <- currency(min, digits = 0L)
if(is.nan(min)){min[is.nan(min)] <- 0}
if(is.infinite(min)){min[is.infinite(min)] <- 0}
max <- max(sub$EstProjectCost)
max <- currency(max, digits = 0L)
if(is.nan(max)){max[is.nan(max)] <- 0}
if(is.infinite(max)){max[is.infinite(max)] <- 0}
tot <- sum(sub$EstProjectCost)
tot <- currency(tot, digits = 0L)
if(is.nan(tot)){tot[is.nan(tot)] <- 0}
if(is.infinite(tot)){tot[is.infinite(tot)] <- 0}

#create bullet points
summary <- block_list(
  fpar(ftext(paste("Quarter", params$quarter, ",", params$year, "Neighborhood Cost Breakdown", sep = " "), reg24)),
  fpar(ftext(paste("Sum of Permits:", tot, sep = " "), reg24)),
  fpar(ftext(paste("Mean:", mean, sep = " "), reg24)),
  fpar(ftext(paste("Median:", median, sep = " "), reg24)),
  fpar(ftext(paste("Range:", min, "-", max, sep = " "), reg24))
)

#create powerpoint slide
report%>%
add_slide(layout = "Two Content")%>%
  ph_with(external_img(here::here("data", "neighborhood_pics", paste(abbr, ".png", sep = "")), height = 3.73, width = 4.19), location = ph_location_left(), use_loc_size = FALSE)%>%
 ph_with(summary, location = ph_location_right(), is_list = TRUE, level_list = c(1, 2, 2, 2))%>%
  ph_with(name, 
               location = ph_location_type(
                 type = "title") )-> report  

#filter out neighborhood
sub02 <- filter(lstqrt, nbhd_name == name)

#create cost and year to date variables for each year
bp20 <- nrow(sub)
bp19 <- nrow(sub02)
cost20 <- mean(sub$EstProjectCost)
cost20 <- currency(cost20, digits = 0L)
if(is.nan(cost20)){cost20[is.nan(cost20)] <- 0}
cost19 <- mean(sub02$EstProjectCost)
cost19 <- currency(cost19, digits = 0L)
if(is.nan(cost19)){cost19[is.nan(cost19)] <- 0}

#create percent change variables
pct_chg_cnt <- (bp20 - bp19)/bp19
pct_chg_cnt <- percent(pct_chg_cnt)
if(is.nan(pct_chg_cnt)){pct_chg_cnt[is.nan(pct_chg_cnt)] <- 0}
if(is.infinite(pct_chg_cnt)){pct_chg_cnt[is.infinite(pct_chg_cnt)] <- "Infinite"}
pct_chg_cost <- (cost20 - cost19)/cost19
pct_chg_cost <- percent(pct_chg_cost)
if(is.nan(pct_chg_cost)){pct_chg_cost[is.nan(pct_chg_cost)] <- 0}
if(is.infinite(pct_chg_cost)){pct_chg_cost[is.infinite(pct_chg_cost)] <- "Infinite"}
  
#create sprints for powerpoint output  
sprint_1 <- sprintf("%s building permits in Quarter %s, %s",
                    bp20, params$quarter, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_cnt == 0, "#00B0F0", ifelse(pct_chg_cnt > 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cost == 0, "#00B0F0", ifelse(pct_chg_cost > 0, "#00B050", "red")), font.size = 20)

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(pct_chg_cnt, "change ", sep = " "), color24a),
       ftext(paste("compared to Quarter ", params$quarter, ", ", params$pastyear, " (", bp19, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(cost20), bold),
       ftext(paste(": Average building permit cost in Quarter ", params$quarter, ", ", params$year, sep = ""), reg24)),
  fpar(ftext(paste(pct_chg_cost, "change", sep = " "), color20a),
       ftext(paste(" compared to Quarter ", params$quarter, ", ", params$pastyear, " (", cost19, ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = paste(name, ": Summary Notes", sep = ""), location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3)) -> report

#summary notes for new_use
df%>%
  filter(nbhd_name == name)%>%
  group_by(new_use)%>%
  summarise(mean = mean(EstProjectCost), count = n())-> use_sub

lstqrt%>%
  filter(nbhd_name == name)%>%
  group_by(new_use)%>%
  summarise(mean = mean(EstProjectCost), count = n())-> use_sub02

# add missing new_use values for Permit Type comparison
use[!(use %in% use_sub$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(use_sub) -> use_sub

if(test == FALSE) {
  add_row(use_sub, new_use = missing_category) -> use_sub
}
use_sub%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> use_sub
#do the same thing for last years quarter
use[!(use %in% use_sub02$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(use_sub02) -> use_sub02

if(test == FALSE) {
  add_row(use_sub02, new_use = missing_category) -> use_sub02
}
use_sub02%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> use_sub02

#create percent change variables for Residential
use_sub%>%
  filter(new_use == "Residential") -> res01
use_sub02%>%
  filter(new_use == "Residential") -> res02
res_chg_cnt <- (as.numeric(res01$count) - as.numeric(res02$count))/as.numeric(res02$count)
res_chg_cnt <- percent(res_chg_cnt)
if(is.nan(res_chg_cnt)){res_chg_cnt[is.nan(res_chg_cnt)] <- 0}
if(is.infinite(res_chg_cnt)){res_chg_cnt[is.infinite(res_chg_cnt)] <- "Infinite"}
res_chg_cost <- (as.numeric(res01$mean) - as.numeric(res02$mean))/as.numeric(res02$mean)
res_chg_cost <- percent(res_chg_cost)
if(is.nan(res_chg_cost)){res_chg_cost[is.nan(res_chg_cost)] <- 0}
if(is.infinite(res_chg_cost)){res_chg_cost[is.infinite(res_chg_cost)] <- "Infinite"}
# text formatting
res_color24a <- fp_text(color = ifelse(res_chg_cnt == 0, "#00B0F0", ifelse(res_chg_cnt > 0, "#00B050", "red")), font.size = 24)
res_color20a <- fp_text(color = ifelse(res_chg_cost == 0, "#00B0F0", ifelse(res_chg_cost > 0, "#00B050", "red")), font.size = 20)

#create percent change variables for Institutional
use_sub%>%
  filter(new_use == "Institutional") -> inst01
use_sub02%>%
  filter(new_use == "Institutional") -> inst02
inst_chg_cnt <- (as.numeric(inst01$count) - as.numeric(inst02$count))/as.numeric(inst02$count)
inst_chg_cnt <- percent(inst_chg_cnt)
if(is.nan(inst_chg_cnt)){inst_chg_cnt[is.nan(inst_chg_cnt)] <- 0}
if(is.infinite(inst_chg_cnt)){inst_chg_cnt[is.infinite(inst_chg_cnt)] <- "Infinite"}
inst_chg_cost <- (as.numeric(inst01$mean) - as.numeric(inst02$mean))/as.numeric(inst02$mean)
inst_chg_cost <- percent(inst_chg_cost)
if(is.nan(inst_chg_cost)){inst_chg_cost[is.nan(inst_chg_cost)] <- 0}
if(is.infinite(inst_chg_cost)){inst_chg_cost[is.infinite(inst_chg_cost)] <- "Infinite"}
# text formatting
inst_color24a <- fp_text(color = ifelse(inst_chg_cnt == 0, "#00B0F0", ifelse(inst_chg_cnt > 0, "#00B050", "red")), font.size = 24)
inst_color20a <- fp_text(color = ifelse(inst_chg_cost == 0, "#00B0F0", ifelse(inst_chg_cost > 0, "#00B050", "red")), font.size = 20)

#create percent change variables for Industrial
use_sub%>%
  filter(new_use == "Industrial") -> ind01
use_sub02%>%
  filter(new_use == "Industrial") -> ind02
ind_chg_cnt <- (as.numeric(ind01$count) - as.numeric(ind02$count))/as.numeric(ind02$count)
ind_chg_cnt <- percent(ind_chg_cnt)
if(is.nan(ind_chg_cnt)){ind_chg_cnt[is.nan(ind_chg_cnt)] <- 0}
if(is.infinite(ind_chg_cnt)){ind_chg_cnt[is.infinite(ind_chg_cnt)] <- "Infinite"}
ind_chg_cost <- (as.numeric(ind01$mean) - as.numeric(ind02$mean))/as.numeric(ind02$mean)
ind_chg_cost <- percent(ind_chg_cost)
if(is.nan(ind_chg_cost)){ind_chg_cost[is.nan(ind_chg_cost)] <- 0}
if(is.infinite(ind_chg_cost)){ind_chg_cost[is.infinite(ind_chg_cost)] <- "Infinite"}
# text formatting
ind_color24a <- fp_text(color = ifelse(ind_chg_cnt == 0, "#00B0F0", ifelse(ind_chg_cnt > 0, "#00B050", "red")), font.size = 24)
ind_color20a <- fp_text(color = ifelse(ind_chg_cost == 0, "#00B0F0", ifelse(ind_chg_cost > 0, "#00B050", "red")), font.size = 20)

#create percent change variables for Commercial
use_sub%>%
  filter(new_use == "Commercial") -> com01
use_sub02%>%
  filter(new_use == "Commercial") -> com02
com_chg_cnt <- (as.numeric(com01$count) - as.numeric(com02$count))/as.numeric(com02$count)
com_chg_cnt <- percent(com_chg_cnt)
if(is.nan(com_chg_cnt)){com_chg_cnt[is.nan(com_chg_cnt)] <- 0}
if(is.infinite(com_chg_cnt)){com_chg_cnt[is.infinite(com_chg_cnt)] <- "Infinite"}
com_chg_cost <- (as.numeric(com01$mean) - as.numeric(com02$mean))/as.numeric(com02$mean)
com_chg_cost <- percent(com_chg_cost)
if(is.nan(com_chg_cost)){com_chg_cost[is.nan(com_chg_cost)] <- 0}
if(is.infinite(com_chg_cost)){com_chg_cost[is.infinite(com_chg_cost)] <- "Infinite"}
# text formatting
com_color24a <- fp_text(color = ifelse(com_chg_cnt == 0, "#00B0F0", ifelse(com_chg_cnt > 0, "#00B050", "red")), font.size = 24)
com_color20a <- fp_text(color = ifelse(com_chg_cost == 0, "#00B0F0", ifelse(com_chg_cost > 0, "#00B050", "red")), font.size = 20)


#create sprints for powerpoint output  
sprint_1 <- sprintf("%s residential permits in Quarter %s, %s",
                    res01$count, params$quarter, params$year)
sprint_2 <- sprintf("%s industrial permits in Quarter %s, %s",
                    ind01$count, params$quarter, params$year)
sprint_3 <- sprintf("%s commercial permits in Quarter %s, %s",
                    com01$count, params$quarter, params$year)
sprint_4 <- sprintf("%s residential permits in Quarter %s, %s",
                    inst01$count, params$quarter, params$year)

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(res_chg_cnt, "change ", sep = " "), res_color24a),
       ftext(paste("compared to Quarter ", params$quarter, ", ", params$pastyear, " (", res02$count, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(currency(res01$mean, digits = 0L)), bold),
       ftext(paste(": Average residential building permit cost in Quarter ", params$quarter, ", ", params$year, sep = ""), reg24)),
  fpar(ftext(paste(res_chg_cost, "change", sep = " "), res_color20a),
       ftext(paste(" compared to Quarter ", params$quarter, ", ", params$pastyear, " (", currency(res02$mean, digits = 0L), ")", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(ind_chg_cnt, "change ", sep = " "), ind_color24a),
       ftext(paste("compared to Quarter ", params$quarter, ", ", params$pastyear, " (", ind02$count, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(currency(ind01$mean, digits = 0L)), bold),
       ftext(paste(": Average industrial building permit cost in Quarter ", params$quarter, ", ", params$year, sep = ""), reg24)),
  fpar(ftext(paste(ind_chg_cost, "change", sep = " "), ind_color20a),
       ftext(paste(" compared to Quarter ", params$quarter, ", ", params$pastyear, " (", currency(ind02$mean, digits = 0L), ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = paste(name, ": Summary Notes", sep = ""), location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_3, boldline)),
  fpar(ftext(paste(com_chg_cnt, "change ", sep = " "), com_color24a),
       ftext(paste("compared to Quarter ", params$quarter, ", ", params$pastyear, " (", com02$count, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(currency(com01$mean, digits = 0L)), bold),
       ftext(paste(": Average commercial building permit cost in Quarter ", params$quarter, ", ", params$year, sep = ""), reg24)),
  fpar(ftext(paste(com_chg_cost, "change", sep = " "), com_color20a),
       ftext(paste(" compared to Quarter ", params$quarter, ", ", params$pastyear, " (", currency(com02$mean, digits = 0L), ")", sep = ""), reg20)),
  fpar(ftext(sprint_4, boldline)),
  fpar(ftext(paste(inst_chg_cnt, "change ", sep = " "), inst_color24a),
       ftext(paste("compared to Quarter ", params$quarter, ", ", params$pastyear, " (", inst02$count, " total building permits)", sep = ""), reg24)),
  fpar(ftext(paste(currency(inst01$mean, digits = 0L)), bold),
       ftext(paste(": Average institutional building permit cost in Quarter ", params$quarter, ", ", params$year, sep = ""), reg24)),
  fpar(ftext(paste(inst_chg_cost, "change", sep = " "), inst_color20a),
       ftext(paste(" compared to Quarter ", params$quarter, ", ", params$pastyear, " (", currency(ind02$mean, digits = 0L), ")", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = paste(name, ": Summary Notes", sep = ""), location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report

#create empty character vector that will become the color palette
col <- character(0)
if("Commercial" %in% sub$new_use){col <- c("Commercial" = "#4daf4a")}
if("Industrial" %in% sub$new_use){col <- c(col, "Industrial" = "#e41a1c")}
if("Institutional" %in% sub$new_use){col <- c(col, "Institutional" = "#984ea3")}
if("Residential" %in% sub$new_use){col <- c(col, "Residential" = "#377eb8")}

#create simple feature
st_as_sf(sub)%>%
  st_transform(crs = 32615) -> shp

#mapping
tm_shape(i) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == num) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  shp%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "new_use",
               palette = col,
               title.col = "Building Permit Type") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> map

#save map as .jpeg
tmap_save(map, file = here::here("results", params$year, "quarterly", params$quarter, abbr, "permituse-map.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "quarterly", params$quarter, abbr, "permituse-map.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(name), 
               location = ph_location_type(
                 type = "title") )-> report

ggplot(sub, aes(lrgcost)) +
  scale_colour_manual(
    values = col,
    aesthetics = c("colour", "fill")
  ) +
  geom_bar(aes(fill = new_use), position = "dodge", stat="count") +
  theme(
    plot.title = element_text(hjust = 0.5),
  )+
  ylab("Number of Permits") +
  xlab("Building Permit Cost") +
  labs(fill = "New Use") -> plot

ggsave(here::here("results",  params$year, "quarterly", params$quarter, abbr, "cost-plot.png"), 
       plot = plot, width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, "quarterly", params$quarter, abbr, "cost-plot.png"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(name, "Permit Use Breakdown"), 
               location = ph_location_type(
                 type = "title") )-> report

#create summary tables for current month and past 6 months
sub%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table

use[!(use %in% table$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table) -> table

if(test == FALSE) {
  add_row(table, new_use = missing_category) -> table
}
table%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use)  -> table

lstqrt%>%
  filter(nbhd_name == name)%>%
  group_by(new_use)%>%
  summarize(mean = mean(EstProjectCost), count = n(), sum = sum(EstProjectCost))%>%
  dplyr::select(new_use, mean, count, sum) -> table1

use[!(use %in% table1$new_use)] -> missing_category
is_empty(missing_category) -> test

as.data.frame(table1) -> table1

if(test == FALSE) {
  add_row(table1, new_use = missing_category) -> table1
}
table1%>%
  replace(., is.na(.), 0)%>%
  arrange(., new_use) -> table1

table$mean <- as.numeric(table$mean)
table$sum <- as.numeric(table$sum)
table$count <- as.numeric(table$count)
table1$mean <- as.numeric(table1$mean)
table1$sum <- as.numeric(table1$sum)
table1$count <- as.numeric(table1$count)

#add totals row
table%>%
  arrange(., new_use) %>%
  adorn_totals(., "row", name = "Total") -> table

#add totals row
table1%>%
  arrange(., new_use) %>%
  adorn_totals(., "row", name = "Total") -> table1

#make summary tables
  flextable(table)%>%
  autofit()%>%
  add_header_lines(values = paste("Quarter ", params$quarter, ", ", params$year, sep = ""))%>%
  set_header_labels(new_use = "Permit Use",
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex

  flex <- colformat_num(flex, j = c("mean", "sum"), prefix = "$", digits = 0) 
  flex <- width(flex, width = 1)
  
  flextable(table1)%>%
  autofit()%>%
  add_header_lines(values = paste("Quarter ", params$quarter, ", ", params$pastyear, sep = ""))%>%
  set_header_labels(new_use = "Permit Use",
    mean = "Average Cost", count = "# of Permits", sum = "Total Value of Permits") -> flex01
  
  flex01 <- colformat_num(flex01, j = c("mean", "sum"), prefix = "$", digits = 0)
  flex01 <- width(flex01, width = 1)

# add powerpoint slide
report%>%
  add_slide(layout = "Two Content")%>%
  ph_with(flex, location = ph_location_left())%>%
  ph_with(flex01, location = ph_location_right())%>%
  ph_with(paste(name, "Permit Breakdown"),
               location = ph_location_type(
                 type = "title")) -> report
 }
}

  # additional notes slide
report%>%
  add_slide()%>%
  ph_with(value = "Additional Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c("Data retreived from https://www.stlouis-mo.gov/data/", "Building permits with a cost of $0 were dropped", "Building permits that were cancelled were dropped", "Infinite change indicates 0 permits in the current or previous time period/comparison month so there was a overall increase or decrease"), location = ph_location_type(type = "body")) -> report

print(report, target = here::here("results", "presentations",  params$year, "quarterly", paste("quarter-", params$quarter, "report", ".pptx", sep = "")))
```

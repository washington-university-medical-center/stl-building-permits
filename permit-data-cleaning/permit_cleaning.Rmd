---
title: "Permit Cleaning Data"
output: html_notebook
---
### Intro
This file is complied by Andrew D. Smith for use by the WUMCRC. Project started on 3/29/2019

## Dependencies and library


```{r}
library(dplyr)
library(RODBC)
library(rgdal)
library(maptools)
library(tidyverse)
library(sp)
library(sf)
library(ggplot2)
```


### set wd


```{r}
setwd("G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning")
```

### import data


```{r}
channel <- odbcDriverConnect("Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning/prmbdo/prmbdo")


#Use odbcDriverConnect instead? odbcConnnectAccess only works on 32-bit#
```

### Run SQL Query to return data

```{r}
data <- sqlQuery( channel , paste ("select *
 from PrmBldg"))
```

### filter only recent permits

For this next line, you will need to change the date. The dates are in the format 'YYYY-MM-DD'. The most recent data is from March of 2019. 


```{r}
data_month <- filter(data, FirstDate > '2019-03-01'& FirstDate < '2019-10-01')
```

### drop unused variables

```{r}
data_month<- select(data_month, -'CancelType', -'OwnerCode', -'StrucType1', -'StrucType2', -'StrucType3', -'NewUseGroup1' , -'NewUseGroup2' , -'NewUseGroup3' , -'OldUseGroup1' , -'OldUseGroup2' , -'OldUseGroup3', -'CorrName' , -'CorrCo', -'CorrAddr' , -'CorrCity', -'CorrState', -'CorrZIP', -'OccName' , -'OccCo', -'OccAddr' , -'OccCity', -'OccState', -'OccZIP' , -'ContrNum', -'ContrName' , -'ContrContact', -'ContrAddr' , -'ContrCity', -'ContrState', -'ContrZIP') 
```

### Filter by Neighborhood




### Recode values to neighborhood names

This code chunk creates a new variable called `nbhd_name` that contains the names of the neighborhoods based on their `Nbrhd` number.

```{r}
data_month <- mutate(data_month, nbhd_name = ifelse(grepl("38", Nbrhd), "Central West End",
                                             ifelse(grepl("39", Nbrhd), "Forest Park South East",
                                             ifelse(grepl("46", Nbrhd), "Skinker DeBaliviere",  
                                             ifelse(grepl("47", Nbrhd), "DeBaliviere Place",
                                             ifelse(grepl("48", Nbrhd), "West End",
                                             ifelse(grepl("49", Nbrhd), "Visitation Park",       
                                             ifelse(grepl("51", Nbrhd), "Academy",       
                                             ifelse(grepl("53", Nbrhd), "Fountain Park",       
                                             ifelse(grepl("54", Nbrhd), "Lewis Place",       
                                             ifelse(grepl("58", Nbrhd), "Vandeventer", NA)))))))))))
```


### rename handle

```{r}
data_month %>%
  rename(HANDLE = Handle) -> data_month
```


### import blank parcel data

This line will pull in the shapefile prcl that is in the working directory


```{r}
shape <- readOGR(dsn = ".", layer = "prcl")
```

### merge data into shapefle using HANDLE

```{r}
shape <- merge(shape, data_month, by="HANDLE", duplicateGeoms = TRUE)
```


### Drop parcels with no permits


```{r}
shape <- shape[!is.na(shape@data$AppType) ,]
```





## Set WD again to send the shapefile to the correct spot


```{r}
setwd("G:/Projects/Monthly-Reports/stl-building-permits/monthly-shapefiles")
```


### write shapefile


```{r}
writeOGR(shape, dsn =".", layer= "permits_MONTH_YEAR1", driver = "ESRI Shapefile")
```














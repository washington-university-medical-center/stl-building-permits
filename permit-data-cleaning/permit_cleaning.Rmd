---
title: "Permit Cleaning Data"
output: html_notebook
---
### Intro
This file is complied by Andrew D. Smith for use by the WUMCRC. Project started on 3/29/2019

## Dependencies and library


```{r}
library(dplyr)
library(RODBC)
library(rgdal)
library(maptools)
library(tidyverse)
library(sp)
library(sf)
library(ggplot2)
```


### set wd


```{r}
setwd("G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning")
```

### import data


```{r}
channel <- odbcConnectAccess("G:/Projects/Monthly-Reports/stl-building-permits/permit-data-cleaning/prmbdo/prmbdo")
```

### Run SQL Query to return data

```{r}
data <- sqlQuery( channel , paste ("select *
 from PrmBldg"))
```

### filter only recent permits

For this next line, you will need to change the date. The dates are in the format 'YYYY-MM-DD'.


```{r}
data_month <- filter(data, FirstDate > '2018-01-01'& FirstDate < '2018-02-01')
```

### drop unused variables

```{r}
data_month<- select(data_month, -'CancelType', -'OwnerCode', -'StrucType1', -'StrucType2', -'StrucType3', -'NewUseGroup1' , -'NewUseGroup2' , -'NewUseGroup3' , -'OldUseGroup1' , -'OldUseGroup2' , -'OldUseGroup3', -'CorrName' , -'CorrCo', -'CorrAddr' , -'CorrCity', -'CorrState', -'CorrZIP', -'OccName' , -'OccCo', -'OccAddr' , -'OccCity', -'OccState', -'OccZIP' , -'ContrNum', -'ContrName' , -'ContrContact', -'ContrAddr' , -'ContrCity', -'ContrState', -'ContrZIP') 
```

### rename handle

```{r}
data_month %>%
  rename(HANDLE = Handle) -> data_month
```


### import blank parcel data

This line will pull in the shapefile prcl that is in the working directory


```{r}
shape <- readOGR(dsn = ".", layer = "prcl")
```

### merge data into shapefle using HANDLE

```{r}
shape <- merge(shape, data_month, by="HANDLE", duplicateGeoms = TRUE)
```


### Drop parcels with no permits


```{r}
shape <- shape[!is.na(shape@data$AppType) ,]
```





## Set WD again to send the shapefile to the correct spot


```{r}
setwd("G:/Projects/Monthly-Reports/stl-building-permits/monthly-shapefiles")
```


### write shapefile


```{r}
writeOGR(shape, dsn =".", layer= "permits_MONTH_YEAR", driver = "ESRI Shapefile")
```
















